+++
title = "Comment configurer Percona Server MongoDB pour divers systèmes d'exploitation?"
description = "Une guide pour testez vos modifications de code entre plateforme. A titre d'exemple, nous nous servirons de cette approche pour créer des packages/archives binaires Percona Server MongoDB pour tous les systèmes d'exploitation pris en charge"
author = "Francis"
date = 2022-01-27
tags = ['MongoDB']
Categories = ["Article de Percona"]
featured_image = "thumbnail/2022/article02.jpg"
images = ["thumbnail/2022/article02.jpg"]
slug = "Percona-Server-MongoDB-pour-divers-systemes-d-exploitation"
+++


Suite à cette série d'articles de blog lancée par Evgeniy Patlan :

- [Comment configurer manuellement Percona Server pour les packages MySQL RPM ](https://www.percona.com/blog/2017/01/20/how-to-manually-build-percona-server-rpm-packages/)
- [Comment créer un serveur Percona pour MySQL à partir de sources](https://www.percona.com/blog/2021/03/10/how-to-build-percona-server-for-mysql-from-sources/)

Nous vous montrerons comment créer [Percona Server pour MongoDB ](https://www.percona.com/software/mongodb/percona-server-for-mongodb)pour différents systèmes d'exploitation **¹** en utilisant Docker sur votre machine/serveur de build Linux local. Dans ce cas précis, nous construirons des packages de **Percona Server pour la version MongoDB 4.4.9-10** pour **Centos 8** et **Debian 11 ( bullseye )** .

Cela peut être utile lorsque vous devez tester vos modifications du code pour différentes plates-formes basées sur RPM/DEB et vous assurer que tout fonctionne comme prévu dans différents environnements. Dans notre cas, cette approche est utilisée pour créer des packages/archives binaires Percona Server for MongoDB pour tous les systèmes d' exploitation pris en charge.

## Préparer l'environnement

- Assurez-vous d'avoir au moins 60 Go d'espace disque libre
- Créez un « dossier de construction » – le dossier où toutes les actions de construction seront effectuées, dans notre cas « **/mnt/psmdb-44/test** »
- Assurez-vous que vous avez installé le package qui fournit **docker** et **docker** **le service** est opérationnel

## Obtenir le script de construction de la version requise²

Vous devez télécharger le script de construction de la version nécessaire dans le dossier « **/mnt/psmdb-44** » :
```
cd /mnt/psmdb-44/
wget https://raw.githubusercontent.com/percona/percona-server-mongodb/psmdb-4.4.9-10/percona-packaging/scripts/psmdb_builder.sh -O psmdb_builder.sh
```

## Créer un serveur Percona pour l'archive source MongoDB

- Veuillez noter que pour la création de l'archive source , nous utilisons le plus ancien système d'exploitation pris en charge, dans ce cas, il s'agit de Centos 7.
```
docker run -ti -u root -v /mnt/psmdb-44:/mnt/psmdb-44 centos:7 sh -c '
set -o xtrace
cd /mnt/psmdb-44
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --install_deps=1
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --repo=https://github.com/percona/percona-server-mongodb.git \
--branch=release-4.4.9-10 --psm_ver=4.4.9 --psm_release=10 --mongo_tools_tag=100.4.1 --jemalloc_tag=psmdb-3.2.11-3.1 --get_sources=1
'
```
- Vérifiez que l'archive source a été créée :
```
$ ls -la /mnt/psmdb-44/source_tarball/
total 88292
drwxr-xr-x. 2 root root     4096 Oct  1 10:58 .
drwxr-xr-x. 5 root root     4096 Oct  1 10:58 ..
-rw-r--r--. 1 root root 90398894 Oct  1 10:58 percona-server-mongodb-4.4.9-10.tar.gz
```
## Construisez le serveur Percona pour le RPM/DEB source générique MongoDB :

Veuillez noter que pour la création de sources génériques RPM/DEB, nous utilisons toujours le plus ancien système d'exploitation basé sur RPM/DEB pris en charge, dans ce cas, Centos 7/ Ubuntu Xénial ( 16.04).

- Compiler le RPM source :
```
docker run -ti -u root -v /mnt/psmdb-44:/mnt/psmdb-44 centos:7 sh -c '
set -o xtrace
cd /mnt/psmdb-44
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --install_deps=1
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --repo=https://github.com/percona/percona-server-mongodb.git \
--branch=release-4.4.9-10 --psm_ver=4.4.9 --psm_release=10 --mongo_tools_tag=100.4.1 --jemalloc_tag=psmdb-3.2.11-3.1 --build_src_rpm=1
'
```
- Créez le DEB source :
```
docker run -ti -u root -v /mnt/psmdb-44:/mnt/psmdb-44 ubuntu:xenial sh -c '
set -o xtrace
cd /mnt/psmdb-44
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --install_deps=1
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --repo=https://github.com/percona/percona-server-mongodb.git \
--branch=release-4.4.9-10 --psm_ver=4.4.9 --psm_release=10 --mongo_tools_tag=100.4.1 --jemalloc_tag=psmdb-3.2.11-3.1 --build_src_deb=1
'
```
- Vérifiez que SRPM et Source DEB ont été créés :
```
$ ls -la /mnt/psmdb-44/srpm/
total 87480
drwxr-xr-x. 2 root root     4096 Oct  1 11:35 .
drwxr-xr-x. 6 root root     4096 Oct  1 11:35 ..
-rw-r--r--. 1 root root 89570312 Oct  1 11:35 percona-server-mongodb-4.4.9-10.generic.src.rpm

$ ls -la /mnt/psmdb-44/source_deb/
total 88312
drwxr-xr-x. 2 root root     4096 Oct  1 11:45 .
drwxr-xr-x. 7 root root     4096 Oct  1 11:45 ..
-rw-r--r--. 1 root root    10724 Oct  1 11:45 percona-server-mongodb_4.4.9-10.debian.tar.xz
-rw-r--r--. 1 root root     1528 Oct  1 11:45 percona-server-mongodb_4.4.9-10.dsc
-rw-r--r--. 1 root root     2075 Oct  1 11:45 percona-server-mongodb_4.4.9-10_source.changes
-rw-r--r--. 1 root root 90398894 Oct  1 11:45 percona-server-mongodb_4.4.9.orig.tar.gz
```
## Créez un serveur Percona pour les RPM/DEB MongoDB :

- Configurer RPM :
```
docker run -ti -u root -v /mnt/psmdb-44:/mnt/psmdb-44 centos:8 sh -c '
set -o xtrace
cd /mnt/psmdb-44
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --install_deps=1
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --repo=https://github.com/percona/percona-server-mongodb.git \
--branch=release-4.4.9-10 --psm_ver=4.4.9 --psm_release=10 --mongo_tools_tag=100.4.1 --jemalloc_tag=psmdb-3.2.11-3.1 --build_rpm=1
'
```
- Configurer DEB :
```
docker run -ti -u root -v /mnt/psmdb-44:/mnt/psmdb-44 debian:bullseye sh -c '
set -o xtrace
cd /mnt/psmdb-44
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --install_deps=1
bash -x ./psmdb_builder.sh --builddir=/mnt/psmdb-44/test --repo=https://github.com/percona/percona-server-mongodb.git \
--branch=release-4.4.9-10 --psm_ver=4.4.9 --psm_release=10 --mongo_tools_tag=100.4.1 --jemalloc_tag=psmdb-3.2.11-3.1 --build_deb=1
'
```
- Vérifiez que les RPM pour Centos 8 et les DEB pour Debian 11 ont été créés :
```
$  ls -la /mnt/psmdb-44/rpm/
total 1538692
drwxr-xr-x. 2 root root      4096 Oct  1 13:19 .
drwxr-xr-x. 9 root root      4096 Oct  1 13:19 ..
-rw-r--r--. 1 root root      8380 Oct  1 13:19 percona-server-mongodb-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root  19603132 Oct  1 13:19 percona-server-mongodb-debugsource-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root  16199100 Oct  1 13:19 percona-server-mongodb-mongos-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root 382301668 Oct  1 13:19 percona-server-mongodb-mongos-debuginfo-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root  37794568 Oct  1 13:19 percona-server-mongodb-server-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root 829718252 Oct  1 13:19 percona-server-mongodb-server-debuginfo-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root  13310328 Oct  1 13:19 percona-server-mongodb-shell-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root 218625728 Oct  1 13:19 percona-server-mongodb-shell-debuginfo-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root  30823056 Oct  1 13:19 percona-server-mongodb-tools-4.4.9-10.el8.x86_64.rpm
-rw-r--r--. 1 root root  27196024 Oct  1 13:19 percona-server-mongodb-tools-debuginfo-4.4.9-10.el8.x86_64.rpm

$  ls -la /mnt/psmdb-44/deb/
total 2335288
drwxr-xr-x. 2 root root       4096 Oct  1 13:16 .
drwxr-xr-x. 9 root root       4096 Oct  1 13:16 ..
-rw-r--r--. 1 root root 2301998432 Oct  1 13:16 percona-server-mongodb-dbg_4.4.9-10.bullseye_amd64.deb
-rw-r--r--. 1 root root   14872728 Oct  1 13:16 percona-server-mongodb-mongos_4.4.9-10.bullseye_amd64.deb
-rw-r--r--. 1 root root   35356944 Oct  1 13:16 percona-server-mongodb-server_4.4.9-10.bullseye_amd64.deb
-rw-r--r--. 1 root root   12274928 Oct  1 13:16 percona-server-mongodb-shell_4.4.9-10.bullseye_amd64.deb
-rw-r--r--. 1 root root   26784020 Oct  1 13:16 percona-server-mongodb-tools_4.4.9-10.bullseye_amd64.deb
-rw-r--r--. 1 root root      18548 Oct  4 13:16 percona-server-mongodb_4.4.9-10.bullseye_amd64.deb
```
Maintenant, les packages sont prêts à être installés pour tester/travailler sur Centos 8 et Debian 11.

Comme vous pouvez le voir ci-dessus, le processus de création de packages pour différents systèmes d'exploitation est assez simple et ne nécessite pas beaucoup de machines physiques/virtuelles. Tout ce dont vous avez besoin est le script de construction et Docker.

De plus, comme vous l'avez peut-être remarqué, toutes les commandes de construction sont similaires les unes aux autres, à l'exception du dernier argument passé, qui définit l'action à effectuer. Une telle approche nous permet d'unifier le processus de construction et de le scripter afin que le dernier argument puisse être passé en paramètre au script. Certes, tous les autres arguments peuvent et doivent également être passés en tant que paramètres au cas où vous voudriez automatiser le processus de construction.

**¹ Systèmes** d'exploitation pris en charge (version psmdb-4.4.9-10) :

- Centos 7
- Centos 8
- Ubuntu Xénial ( 16.04)
- Ubuntu Bionique ( 18.04)
- Ubuntu Focale( 20.04)
- Debian (9)
- Debian Buster(10)
- DebianName oeil de boeuf (11)

**²** Afin de configurer Percona Server pour MongoDB d'une autre version, vous devez utiliser le script de construction de la version appropriée. Par exemple, il est nécessaire de configurer Percona Server pour MongoDB version 4.2.7-7 :

- Ouvrez notre repo sur <https://github.com/percona/percona-server-mongodb>
- Sélectionnez la version requise dans la liste des balises et basculez vers celle-ci (le lien pour ce cas sera le suivant : [https://github.com/percona/percona-server-mongodb/tree/psmdb-4.2.7-7 ](https://github.com/percona/percona-server-mongodb/tree/psmdb-4.2.7-7))
- Téléchargez le script de construction : <https://raw.githubusercontent.com/percona/percona-server-mongodb/psmdb-4.2.7-7/percona-packaging/scripts/psmdb_builder.sh>
- Effectuez les étapes de la publication en utilisant le script de construction pour la version 4.2.7-7

Source : [Percona Blog](https://www.percona.com/blog/how-to-build-percona-server-for-mongodb-for-various-operating-systems/)
