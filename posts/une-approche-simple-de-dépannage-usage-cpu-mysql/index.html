<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Une approche simple de dépannage usage elevé de CPU sur MySQL | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Une approche simple de dépannage usage elevé de CPU sur MySQL par Juan Arruti et Leonardo Bacchi Fernandes"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Une approche simple de dépannage usage elevé de CPU sur MySQL"><meta property="og:description" content="Une approche simple de dépannage usage elevé de CPU sur MySQL par Juan Arruti et Leonardo Bacchi Fernandes"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/une-approche-simple-de-d%C3%A9pannage-usage-cpu-mysql/"><meta property="article:published_time" content="2021-07-09T11:43:01+04:00"><meta property="article:modified_time" content="2021-07-09T11:43:01+04:00"><meta itemprop=name content="Une approche simple de dépannage usage elevé de CPU sur MySQL"><meta itemprop=description content="Une approche simple de dépannage usage elevé de CPU sur MySQL par Juan Arruti et Leonardo Bacchi Fernandes"><meta itemprop=datePublished content="2021-07-09T11:43:01+04:00"><meta itemprop=dateModified content="2021-07-09T11:43:01+04:00"><meta itemprop=wordCount content="1361"><meta itemprop=keywords content="MySQL,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Une approche simple de dépannage usage elevé de CPU sur MySQL"><meta name=twitter:description content="Une approche simple de dépannage usage elevé de CPU sur MySQL par Juan Arruti et Leonardo Bacchi Fernandes"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/une-approche-simple-de-d%C3%A9pannage-usage-cpu-mysql/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/une-approche-simple-de-d%C3%A9pannage-usage-cpu-mysql/&text=Une%20approche%20simple%20de%20d%c3%a9pannage%20usage%20elev%c3%a9%20de%20CPU%20sur%20MySQL" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/une-approche-simple-de-d%C3%A9pannage-usage-cpu-mysql/&title=Une%20approche%20simple%20de%20d%c3%a9pannage%20usage%20elev%c3%a9%20de%20CPU%20sur%20MySQL" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Une approche simple de dépannage usage elevé de CPU sur MySQL</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-07-09T11:43:01+04:00>July 9, 2021</time>
<span class="f6 mv4 dib tracked">- 7 minutes read</span>
<span class="f6 mv4 dib tracked">- 1361 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p>Un de nos clients a récemment demandé s'il était possible d'identifier, du côté de MySQL , la requête qui provoque une utilisation élevée du processeur sur son système. L'utilisation d'outils de système d'exploitation simples pour trouver le coupable est une technique largement utilisée depuis longtemps par les administrateurs de base de données PostgreSQL et Oracle, mais cela n'a pas fonctionné pour MySQL car historiquement, nous manquions d'instrumentation pour faire correspondre un thread de système d'exploitation avec un thread processlist - jusqu'à récemment.</p><p>Percona a ajouté la prise en charge du mappage des identifiants de liste de processus aux identifiants de thread du système d'exploitation via la colonne TID de la table information_schema.processlist à partir de Percona Server pour MySQL 5.6.27. Avec la sortie de 5.7, MySQL a suivi sa propre implémentation en étendant la table PERFORMANCE_SCHEMA.THREADS et en ajoutant une nouvelle colonne nommée THREAD_OS_ID, que Percona Server pour MySQL a adoptée à la place de la sienne, car elle reste généralement aussi proche de l'upstream que possible.</p><p>L'approche suivante est utile dans les cas où une requête surcharge un processeur particulier alors que d'autres cœurs fonctionnent normalement. Pour les cas où il s'agit d'un problème général d'utilisation du processeur, différentes méthodes peuvent être utilisées, comme celle décrite dans cet autre article de blog <a href=https://www.percona.com/blog/2019/03/07/reducing-high-cpu-on-mysql-a-case-study/>Réduire le processeur élevé sur MySQL : une étude de cas</a></p><p>Comment pouvons-nous utiliser cette nouvelle colonne pour savoir quelle session utilise le plus de ressources CPU dans ma base de données ?</p><p>Utilisons un exemple :</p><p>Pour résoudre les problèmes de CPU, nous pouvons utiliser plusieurs outils, tels que top ou pidstat (nécessite le package sysstat ). Dans l'exemple suivant, nous utiliserons pidstat . L'outil a une option (-t) qui change sa vue de processus (la valeur par défaut) en threads, où il affiche les threads associés au sein d'un processus donné. Nous pouvons l'utiliser pour savoir quel thread consomme le plus de CPU sur notre serveur. Ajout du paramètre -p avec l'identifiant du processus mysql afin que l'outil n'affiche que les threads MySQL, ce qui nous permet de résoudre plus facilement les problèmes. Le dernier paramètre (1) est d'afficher un échantillon par seconde :</p><p>La commande est pidstat -t -p &lt; mysqld_pid > 1 :</p><pre><code>shell&gt; pidstat -t -p 31258 1
03:31:06 PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command
[...]
03:31:07 PM 10014         -     32039    5.00    1.00    0.00    6.00    22  |__mysqld
03:31:07 PM 10014         -     32040    5.00    1.00    0.00    6.00    23  |__mysqld
03:31:07 PM 10014         -     32042    6.00    1.00    0.00    7.00     8  |__mysqld
03:31:07 PM 10014         -     32047    5.00    1.00    0.00    6.00     6  |__mysqld
03:31:07 PM 10014         -     32048    5.00    1.00    0.00    6.00    15  |__mysqld
03:31:07 PM 10014         -     32049    5.00    1.00    0.00    6.00    14  |__mysqld
03:31:07 PM 10014         -     32052    5.00    1.00    0.00    6.00    14  |__mysqld
03:31:07 PM 10014         -     32053   94.00    0.00    0.00   94.00     9  |__mysqld
03:31:07 PM 10014         -     32055    4.00    1.00    0.00    5.00    10  |__mysqld
03:31:07 PM 10014         -      4275    5.00    1.00    0.00    6.00    10  |__mysqld
03:31:07 PM 10014         -      4276    5.00    1.00    0.00    6.00     7  |__mysqld
03:31:07 PM 10014         -      4277    6.00    1.00    0.00    7.00    15  |__mysqld
03:31:07 PM 10014         -      4278    5.00    1.00    0.00    6.00    18  |__mysqld
03:31:07 PM 10014         -      4279    5.00    1.00    0.00    6.00    10  |__mysqld
03:31:07 PM 10014         -      4280    5.00    1.00    0.00    6.00    12  |__mysqld
03:31:07 PM 10014         -      4281    5.00    1.00    0.00    6.00    11  |__mysqld
03:31:07 PM 10014         -      4282    4.00    1.00    0.00    5.00     2  |__mysqld
03:31:07 PM 10014         -     35261    0.00    0.00    0.00    0.00     4  |__mysqld
03:31:07 PM 10014         -     36153    0.00    0.00    0.00    0.00     5  |__mysqld
</code></pre><p>Nous pouvons voir que le thread 32053 consomme le plus de CPU de loin, et nous nous sommes assurés de vérifier que la consommation est constante sur plusieurs échantillons de pidstat . En utilisant ces informations, nous pouvons nous connecter à la base de données et utiliser la requête suivante pour savoir quel thread MySQL est le fautif:</p><pre><code>mysql &gt; select * from performance_schema.threads where THREAD_OS_ID = 32053 \G
*************************** 1. row ***************************
          THREAD_ID: 686
               NAME: thread/sql/one_connection
               TYPE: FOREGROUND
     PROCESSLIST_ID: 590
   PROCESSLIST_USER: msandbox
   PROCESSLIST_HOST: localhost
     PROCESSLIST_DB: NULL
PROCESSLIST_COMMAND: Query
   PROCESSLIST_TIME: 0
  PROCESSLIST_STATE: Sending data
   PROCESSLIST_INFO: select * from test.joinit where b = 'a a eveniet ut.'
   PARENT_THREAD_ID: NULL
               ROLE: NULL
       INSTRUMENTED: YES
            HISTORY: YES
    CONNECTION_TYPE: SSL/TLS
       THREAD_OS_ID: 32053
1 row in set (0.00 sec)
</code></pre><p>C'est parti ! Nous savons maintenant que la consommation élevée du processeur provient d'une requête dans la table joinit , exécutée par l'utilisateur msandbox depuis localhost dans le test de la base de données. En utilisant ces informations, nous pouvons dépanner la requête et vérifier le plan d'exécution avec la commande EXPLAIN pour voir s'il y a place à amélioration.</p><pre><code>mysql &gt; explain select * from test.joinit where b = 'a a eveniet ut.' \G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: joinit
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 7170836
     filtered: 10.00
        Extra: Using where
1 row in set, 1 warning (0.00 sec)
</code></pre><p>Dans ce cas, c'était un simple index qui manquait !</p><pre><code>mysql &gt; alter table test.joinit add index (b) ;
Query OK, 0 rows affected (15.18 sec)
Records: 0  Duplicates: 0  Warnings: 0
</code></pre><p>Après avoir créé l'index, nous ne voyons plus de pics de processeur :</p><pre><code>shell&gt; pidstat -t -p 31258 1
03:37:53 PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command
[...]
03:37:54 PM 10014         -     32039   25.00    6.00    0.00   31.00     0  |__mysqld
03:37:54 PM 10014         -     32040   25.00    5.00    0.00   30.00    21  |__mysqld
03:37:54 PM 10014         -     32042   25.00    6.00    0.00   31.00    20  |__mysqld
03:37:54 PM 10014         -     32047   25.00    4.00    0.00   29.00    23  |__mysqld
03:37:54 PM 10014         -     32048   25.00    7.00    0.00   32.00    22  |__mysqld
03:37:54 PM 10014         -     32049   23.00    6.00    0.00   29.00     4  |__mysqld
03:37:54 PM 10014         -     32052   23.00    7.00    0.00   30.00    14  |__mysqld
03:37:54 PM 10014         -     32053   10.00    2.00    0.00   12.00    11  |__mysqld
03:37:54 PM 10014         -     32055   24.00    6.00    0.00   30.00     1  |__mysqld
03:37:54 PM 10014         -      4275   25.00    6.00    0.00   31.00     7  |__mysqld
03:37:54 PM 10014         -      4276   25.00    6.00    0.00   31.00     1  |__mysqld
03:37:54 PM 10014         -      4277   24.00    5.00    0.00   29.00    14  |__mysqld
03:37:54 PM 10014         -      4278   24.00    6.00    0.00   30.00     9  |__mysqld
03:37:54 PM 10014         -      4279   25.00    5.00    0.00   30.00     6  |__mysqld
03:37:54 PM 10014         -      4280   26.00    5.00    0.00   31.00    14  |__mysqld
03:37:54 PM 10014         -      4281   24.00    6.00    0.00   30.00    10  |__mysqld
03:37:54 PM 10014         -      4282   25.00    6.00    0.00   31.00    10  |__mysqld
03:37:54 PM 10014         -     35261    0.00    0.00    0.00    0.00     4  |__mysqld
03:37:54 PM 10014         -     36153    0.00    0.00    0.00    0.00     5  |__mysqld
</code></pre><p>Pourquoi ne pas utiliser cette approche pour résoudre les problèmes d'E/S et de mémoire ?</p><p>Le problème avec la mesure des threads IO du côté du système d'exploitation est que la plupart des opérations MySQL IO sont effectuées par des threads d'arrière-plan, tels que les threads read, write et nettoyeur de page. Pour mesurer les threads IO, vous pouvez utiliser des outils tels que pidstat avec l'option -d (IO au lieu de CPU) ou iostat avec -H (par thread). Si vous avez un thread très gourmand en E/S, vous pourrez peut-être le voir, mais sachez que les résultats peuvent être trompeurs en raison des opérations de thread en arrière-plan.</p><p>La consommation de mémoire est une ressource encore plus délicate à mesurer du côté du système d'exploitation, car toute la mémoire est allouée sous le processus MySQL , et puisque c'est MySQL qui gère son accès mémoire, il est transparent pour le système d'exploitation quel thread consomme le plus de mémoire. Pour cela, nous pouvons utiliser l' <a href=https://dev.mysql.com/doc/refman/5.7/en/memory-summary-tables.html>instrumentation de mémoire perfomance_schema disponible à partir de 5.7 </a>.</p><p>Conclusion</p><p>Il existe de nombreuses approches pour résoudre les problèmes d'utilisation élevée du processeur, mais nous présentons ici une approche simple et largement utilisée sur les bases de données Oracle et PostgreSQL qui peut être adaptée à MySQL , à partir de la version 5.7. En traçant la consommation des threads du système d'exploitation jusqu'au côté de la base de données, nous pouvons détecter rapidement les requêtes gourmandes en CPU qui affectent les performances du système.</p><p>Page source : <a href=https://www.percona.com/blog/2020/04/23/a-simple-approach-to-troubleshooting-high-cpu-in-mysql/>Percona</a></p><ul class=pa0><li class=list><a href=/tags/mysql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MySQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2021</a><div></div></div></footer></body></html>