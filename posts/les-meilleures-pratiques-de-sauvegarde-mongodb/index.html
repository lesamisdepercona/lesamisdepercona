<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Pourquoi faire des sauvegardes? | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Traduit à partir de l'article de Divyanshu Soni intitulé, MongoDB Backup Best Practices"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Pourquoi faire des sauvegardes?"><meta property="og:description" content="Traduit à partir de l'article de Divyanshu Soni intitulé, MongoDB Backup Best Practices"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/les-meilleures-pratiques-de-sauvegarde-mongodb/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail/amisdepercona21-004.jpg"><meta property="article:published_time" content="2021-06-01T11:43:01+04:00"><meta property="article:modified_time" content="2021-06-01T11:43:01+04:00"><meta itemprop=name content="Pourquoi faire des sauvegardes?"><meta itemprop=description content="Traduit à partir de l'article de Divyanshu Soni intitulé, MongoDB Backup Best Practices"><meta itemprop=datePublished content="2021-06-01T11:43:01+04:00"><meta itemprop=dateModified content="2021-06-01T11:43:01+04:00"><meta itemprop=wordCount content="3245"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail/amisdepercona21-004.jpg"><meta itemprop=keywords content="MongoDB,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail/amisdepercona21-004.jpg"><meta name=twitter:title content="Pourquoi faire des sauvegardes?"><meta name=twitter:description content="Traduit à partir de l'article de Divyanshu Soni intitulé, MongoDB Backup Best Practices"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/les-meilleures-pratiques-de-sauvegarde-mongodb/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/les-meilleures-pratiques-de-sauvegarde-mongodb/&text=Pourquoi%20faire%20des%20sauvegardes?" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/les-meilleures-pratiques-de-sauvegarde-mongodb/&title=Pourquoi%20faire%20des%20sauvegardes?" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Pourquoi faire des sauvegardes?</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-06-01T11:43:01+04:00>June 1, 2021</time>
<span class="f6 mv4 dib tracked">- 16 minutes read</span>
<span class="f6 mv4 dib tracked">- 3245 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p>Les sauvegardes régulières de la base de données sont essentielles pour se prémunir contre les événements de perte de données involontaires. Ils sont encore plus importants pour la restauration et la poursuite des opérations commerciales.</p><p>Dans ce blog, nous discuterons de différentes stratégies de sauvegarde et de leurs cas d'utilisation, ainsi que des avantages et des inconvénients et de quelques autres conseils.</p><p>En règle générale, il existe deux types de sauvegardes utilisées avec des technologies de bases de données telles que MongoDB :</p><ul><li><strong>Sauvegardes logiques</strong></li><li><strong>Sauvegardes physiques</strong></li></ul><p>De plus, lorsque vous travaillez avec des sauvegardes logiques, nous avons également la possibilité d'effectuer des sauvegardes incrémentielles où nous capturons les deltas ou les modifications de données incrémentielles effectuées entre les sauvegardes complètes pour minimiser la quantité de perte de données en cas de sinistre.</p><p>Nous discuterons de ces deux options de sauvegarde, de la manière de les utiliser et de celle qui convient le mieux en fonction des exigences et de la configuration de l'environnement.</p><p>Nous examinerons également notre utilitaire de sauvegarde open source conçu sur mesure pour éviter les coûts et les logiciels propriétaires - <strong><a href=https://www.percona.com/software/mongodb/percona-backup-for-mongodb>Percona BackUp pour MongoDB</a></strong> ou PBM. PBM est un outil de sauvegarde de communauté entièrement pris en charge, capable d'effectuer des sauvegardes cohérentes côté cluster dans MongoDB pour les jeux de réplicas et les clusters partitionnés.</p><p>Sauvegardes logiques</p><p>Ce sont les types de sauvegardes où les données sont vidées des bases de données dans les fichiers de sauvegarde. Une sauvegarde logique avec MongoDB signifie que vous allez vider les données dans un fichier au format BSON.</p><p>Pendant les sauvegardes logiques, à l'aide de l'API client, les données sont lues depuis le serveur et renvoyées vers la même API qui sera sérialisée et écrite dans respectivement ». bson »,«. json »ou«. csv » sauvegarde des fichiers sur le disque en fonction du type d'utilitaires de sauvegarde utilisé.</p><p>MongoDB propose ci-dessous l'utilitaire pour effectuer les sauvegardes logiques :</p><p><strong>Mongodump</strong> : prend le vidage / sauvegarde des bases de données dans ". bson "qui peut être restauré ultérieurement en rejouant les mêmes instructions logiques capturées dans les fichiers de vidage dans les bases de données.</p><pre><code>mongodump --host=mongodb1.example.net --port=27017 --username=user --authenticationDatabase=admin --db=demo --collection=events --out=/opt/backup/mongodump-2011-10-24
</code></pre><p><strong>Remarque</strong> : Si nous ne spécifions pas explicitement le nom de la base de données ou le nom de la collection dans la syntaxe « mongodump » ci-dessus, la sauvegarde sera effectuée pour la base de données entière ou les collections respectivement. Si «autorisation» est activée, nous devons spécifier « authenticationDatabase »</p><p>De plus, vous devez utiliser «- oplog » pour prendre les données incrémentielles pendant que la sauvegarde est toujours en cours, nous pouvons spécifier «- oplog » avec mongodump . Gardez à l'esprit que cela ne fonctionnera pas avec –db et –collection car il ne fonctionnera que pour des sauvegardes de bases de données entières</p><pre><code>mongodump --host=mongodb1.example.net --port=27017 --username=user --authenticationDatabase=admin --oplog --out=/opt/backup/mongodump-2011-10-24
</code></pre><p><strong>Avantages:</strong></p><ol><li>Il peut prendre la sauvegarde à un niveau plus granulaire comme une base de données spécifique ou une collection qui sera utile lors de la restauration.</li><li>Ne vous oblige pas à interrompre les écritures sur un nœud spécifique sur lequel vous exécuterez la sauvegarde. Par conséquent, le nœud serait toujours disponible pour d'autres opérations.</li></ol><p><strong>Inconvénients</strong> :</p><ol><li>Comme il lit toutes les données, il peut être lent et nécessitera également des lectures de disque pour les bases de données plus grandes que la RAM disponible pour le cache WT. La pression du cache WT augmente, ce qui ralentit les performances.</li><li>Il ne capture pas les données d'index dans le fichier de sauvegarde des métadonnées. Ainsi, lors de la restauration, tous les index doivent être construits à nouveau pour chaque collection après la réinsertion de la collection. Cela sera fait en série en un seul passage dans la collection une fois les inserts terminés, ce qui peut ajouter beaucoup de temps pour les restaurations de grandes collections.</li><li>La vitesse de sauvegarde dépend également des IOPS allouées et du type de stockage, car de nombreuses lectures / écritures se produiraient au cours de ce processus.</li><li>Les sauvegardes logiques telles que mongodump prennent en général beaucoup de temps pour les grands systèmes.</li></ol><p><strong>Conseil de bonne pratique</strong> : Il est toujours conseillé d'utiliser des serveurs secondaires pour les sauvegardes afin d'éviter une dégradation inutile des performances sur le nœud PRIMARY.</p><p>Comme nous avons différents types de configurations d'environnement, nous devrions aborder chacune d'elles comme ci-dessous.</p><ol><li><strong>Jeu de réplicas</strong> : il est toujours préférable de s'exécuter sur des secondaires .</li><li><strong>Clusters de fragments</strong> : effectuez une sauvegarde des réplicas du serveur de configuration et de chaque partition individuellement à l'aide de leurs nœuds secondaires.</li></ol><p>Puisque nous discutons de systèmes de bases de données distribuées comme des clusters fragmentés, nous devons également garder à l'esprit que nous voulons avoir une cohérence dans nos sauvegardes à un moment donné. (Les sauvegardes des jeux de réplicas utilisant mongodump sont généralement cohérentes avec «- oplog »)</p><p>Parlons de ce scénario dans lequel l'application écrit toujours des données et ne peut pas être arrêtée pour des raisons commerciales. Même si nous prenons une sauvegarde du serveur de configuration et de chaque partition séparément, les sauvegardes de chaque partition se termineront à des moments différents en raison du volume de données, de la distribution des données, de la charge, etc.</p><p>Vient maintenant la partie restauration en ce qui concerne les sauvegardes logiques. Comme pour les sauvegardes, MongoDB fournit les utilitaires ci-dessous à des fins de restauration.</p><p><strong>Mongorestore</strong> : Restaure les fichiers de vidage créés par « mongodump ». La recréation d'index n'aura lieu qu'après la restauration des données, ce qui entraîne l'utilisation de ressources mémoire et de temps supplémentaires.</p><p><code>mongorestore --host=mongodb1.example.net --port=27017 --username=user --password --authenticationDatabase=admin --db=demo --collection=events /opt/backup/mongodump-2011-10-24/events.bson</code></p><p>Pour la restauration du vidage incrémentiel, nous pouvons ajouter - oplogReplay dans la syntaxe ci-dessus pour rejouer également les entrées oplog .</p><p><strong>Conseil de</strong> bonne <strong>pratique</strong> : Le «- oplogReplay » ne peut pas être utilisé avec les indicateurs –db et –collection car il ne fonctionnera que lors de la restauration de toutes les bases de données.</p><p><strong>Percona Backup pour MongoDB</strong></p><p>Il s'agit d'une solution distribuée à faible impact pour réaliser des sauvegardes cohérentes des clusters fragmentés MongoDB et des jeux de réplicas. Percona Backup for MongoDB permet de surmonter les problèmes de cohérence tout en effectuant des sauvegardes de clusters partitionnés. Percona Backup for MongoDB est un outil de ligne de commande simple de par sa conception qui se prête bien à la sauvegarde d'ensembles de données plus volumineux. PBM utilise la bibliothèque «s2» plus rapide et les threads parallélisés pour améliorer la vitesse et les performances si des threads supplémentaires sont disponibles en tant que ressources.</p><p><strong>Les principaux avantages du PBM sont les suivants:</strong></p><ul><li>Permet des sauvegardes avec jeu de réplicas et offre une cohérence fragmentées du cluster via oplog capture</li><li>Fournit la cohérence des transactions distribuées avec MongoDB 4.2+</li><li>Sauvegarde n'importe où - dans le cloud (utilisation de n'importe quel stockage compatible S3) ou sur site avec un système de fichiers distant monté localement</li><li>Vous permet de choisir les algorithmes de compression à utiliser. Dans certaines expériences internes, la bibliothèque «s2» avec compression rapide exécutée en parallèle avec plusieurs threads était significativement plus rapide que gzip classique . Mise en garde: C'est bon tant que vous disposez des ressources supplémentaires disponibles pour exécuter les threads parallèles.</li><li><strong>Enregistre la journalisation de la progression de la sauvegarde.</strong> Si vous souhaitez voir la vitesse de la sauvegarde (taux de téléchargement en Mo/s), vous pouvez consulter les journaux du nœud pbm -agent pour voir la progression actuelle. Si vous avez une sauvegarde volumineuse, vous pouvez suivre la progression de la sauvegarde dans les journaux de pbm -agent. Une ligne est ajoutée toutes les minutes indiquant les octets copiés par rapport à la taille totale de la collection actuelle.</li><li>PBM permet des récupérations ponctuelles - restauration d'une base de données jusqu'à un moment précis. PIT-R restaure les données à partir d'une sauvegarde, puis rejoue toutes les actions qui sont arrivées aux données jusqu'au moment spécifié à partir des tranches oplog .</li><li>Les PITR vous aident à éviter la perte de données lors d'un sinistre tel qu'une base de données en panne, la suppression accidentelle de données ou la suppression de tables et la mise à jour indésirable de plusieurs champs au lieu d'un seul.</li><li>PBM est optimisé pour permettre des sauvegardes et avoir un impact minimal sur vos performances de production.</li></ul><p><strong>Conseil de bonne pratique</strong> : utilisez PBM pour chronométrer d'énormes jeux de sauvegarde. Beaucoup de gens ne réalisent pas combien de temps il faut pour sauvegarder de très grands ensembles de données. Et ils sont généralement très surpris du temps qu'il faut pour les restaurer! Surtout si vous entrez ou sortez de types de stockage qui peuvent limiter la bande passante / le trafic réseau.</p><p><strong>Conseil de bonne pratique</strong> : lors de l'exécution de PBM à partir d'un script non supervisé, nous vous recommandons d'utiliser une chaîne de connexion de jeu de réplicas. Une chaîne de connexion directe ou autonome échouera si cet hôte mongod est indisponible ou temporairement indisponible.</p><p>Lorsqu'une sauvegarde PBM est déclenchée, elle queues et capture les oplog de config jeu de réplicas du serveur et tous les tessons pendant que la sauvegarde est toujours en cours d'exécution, assurant ainsi la cohérence une fois la sauvegarde terminée.</p><p>Il a une fonction de prendre des sauvegardes incrémentielles ainsi que la sauvegarde complète de la base de données avec le paramètre «PITR» activé. Il fait tout cela en exécutant « pbm -agent» sur les nœuds de base de données (« mongod ») du cluster et il est responsable des sauvegardes et des restaurations.</p><p>Comme nous pouvons le voir ci-dessous, la commande « pbm list» affiche la liste complète des sauvegardes dans la section Sauvegarde des instantanés ainsi que les sauvegardes incrémentielles dans la section «PITR».</p><p>Voici l'exemple de sortie Output:</p><pre><code>$ pbm list
Backup snapshots:
     2020-09-10T12:19:10Z
     2020-09-14T10:44:44Z
     2020-09-14T14:26:20Z
     2020-09-17T16:46:59Z
PITR &lt;on&gt;:
     2020-09-14T14:26:40 - 2020-09-16T17:27:26
     2020-09-17T16:47:20 - 2020-09-17T16:57:55
</code></pre><p>Si vous avez une sauvegarde volumineuse, vous pouvez suivre la progression de la sauvegarde dans les journaux de pbm-agent. Jetons également un œil à la sortie Output de « pbm-agent» pendant qu'il effectue la sauvegarde.</p><pre><code>Aug 19 08:46:51 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 08:46:51 Got command backup [{backup {2020-08-19T08:46:50Z s2} { } { 0} 1597826810}]
Aug 19 08:47:07 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 08:47:07 [INFO] backup/2020-08-19T08:46:50Z: backup started
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.891+0000        writing admin.system.users to archive on stdout
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.895+0000        done dumping admin.system.users (2 documents)
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.895+0000        writing admin.system.roles to archive on stdout
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.904+0000        done dumping admin.system.roles (1 document)
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.904+0000        writing admin.system.version to archive on stdout
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.914+0000        done dumping admin.system.version (5 documents)
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.914+0000        writing testmongo.col to archive on stdout
Aug 19 08:47:09 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:09.942+0000        writing test.collC to archive on stdout
Aug 19 08:47:13 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:13.499+0000        done dumping test.collC (1146923 documents)
Aug 19 08:47:13 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:13.500+0000        writing test.collA to archive on stdout
Aug 19 08:47:27 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:27.964+0000        done dumping test.collA (389616 documents)
Aug 19 08:47:27 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:27.965+0000        writing test.collG to archive on stdout
Aug 19 08:47:54 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:54.891+0000        done dumping testmongo.col (13280501 documents)
Aug 19 08:47:54 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T08:47:54.896+0000        writing test.collF to archive on stdout
Aug 19 08:48:09 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 08:48:09 [........................]  test.collG    1533/195563   (0.8%)
Aug 19 08:48:09 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 08:48:09 [####################....]  test.collF  116432/134747  (86.4%)
Aug 19 10:01:09 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:01:09 [#######################.]  test.collG  195209/195563  (99.8%)
Aug 19 10:01:17 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:01:17 [########################]  test.collG  195563/195563  (100.0%)
Aug 19 10:01:17 ip-172-30-2-122 pbm-agent[24331]: 2020-08-19T10:01:17.650+0000        done dumping test.collG (195563 documents)
Aug 19 10:01:20 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:01:20 [INFO] backup/2020-08-19T08:46:50Z: mongodump finished, waiting for the oplog
Aug 19 10:11:04 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:11:04 [INFO] backup/2020-08-19T08:46:50Z: backup finished
Aug 19 10:11:05 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:11:05 [INFO] pitr: streaming started from 2020-08-19 08:47:09 +0000 UTC / 1597826829
Aug 19 10:29:37 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:29:37 [INFO] pitr: created chunk 2020-08-19T08:47:09 - 2020-08-19T10:20:59. Next chunk creation scheduled to begin at ~2020-08-19T10:31:05
Aug 19 10:39:34 ip-172-30-2-122 pbm-agent[24331]: 2020/08/19 10:39:34 [INFO] pitr: created chunk 2020-08-19T10:20:59 - 2020-08-19T10:30:59. Next chunk creation scheduled to begin at ~2020-08-19T10:41:05 
</code></pre><p>Les trois dernières lignes de la sortie Output ci-dessus signifient que la sauvegarde complète est terminée et que la sauvegarde incrémentielle est démarrée avec un intervalle de veille de 10 minutes. Ceci est un exemple de la journalisation de la progression de la sauvegarde mentionnée ci-dessus.</p><p>Nous parlerons davanta de <strong>Percona Backup pour MongoDB</strong> dans un prochain article de blog. D'ici là, vous pouvez trouver plus de détails sur la page de documentation <a href=https://www.percona.com/doc/percona-backup-mongodb/index.html>Percona Backup pour MongoDB</a> sur notre site Web.</p><p><strong>Sauvegardes physiques / système de fichiers</strong></p><p>Cela implique de créer un instantané ou de copier les fichiers de données MongoDB sous-jacents ( -dbPath ) à un moment donné, et de permettre à la base de données de se restaurer proprement en utilisant l'état capturé dans les fichiers instantanés . Ils contribuent à sauvegarder rapidement des bases de données volumineuses, en particulier lorsqu'ils sont utilisés avec des instantanés de système de fichiers, tels que des <a href=http://tldp.org/HOWTO/LVM-HOWTO/snapshots_backup.html>instantanés LVM</a> , ou des instantanés de volume de stockage en bloc.</p><p>Il existe plusieurs méthodes générales pour effectuer la sauvegarde au niveau du système de fichiers, également appelées sauvegardes physiques.</p><ol><li>Copie manuelle de l'intégralité des fichiers de données (à l'aide de Rsync → Dépend de la bande passante N / W)</li><li>Instantanés basés sur LVM</li><li>Instantanés de disque basés sur le cloud (AWS / GCP / Azure ou tout autre fournisseur de cloud)</li><li><strong>Percona Server for MongoDB</strong> comprend également un système de <strong>sauvegarde à chaud</strong> open source intégré qui crée une sauvegarde de données physiques sur un serveur en cours d'exécution sans performances notables ni dégradation de fonctionnement. Vous pouvez trouver plus d'informations sur <strong>Percona Server for MongoDB Hot Backup</strong> <a href=https://www.percona.com/doc/percona-server-for-mongodb/LATEST/hot-backup.html>ici</a> .</li></ol><p>Nous discuterons de toutes ces options ci-dessus, mais tout d'abord, examinons les avantages et les inconvénients des sauvegardes physiques par rapport aux sauvegardes logiques.</p><p><strong>Avantages</strong> : ** **</p><ol><li>Elles sont au moins aussi rapides et généralement plus rapides que les sauvegardes logiques.</li><li>Peut être facilement copié ou partagé avec des serveurs distants ou un NAS connecté.</li><li>Recommandé pour les grands ensembles de données en raison de la vitesse et de la fiabilité</li><li>Peut être pratique lors de la création de nouveaux nœuds au sein du même cluster ou d'un nouveau cluster</li></ol><p><strong>Inconvénients</strong> : ** **</p><ol><li>Il n'est pas possible de restaurer à un niveau moins granulaire, tel qu'une restauration de base de données ou de collection spécifique</li><li>Les sauvegardes incrémentielles ne peuvent pas encore être réalisées</li><li>Un nœud dédié est recommandé pour la sauvegarde (il peut s'agir d'un nœud caché) car il nécessite l'arrêt des écritures ou l'arrêt proprement de « mongod » avant le cliché sur le nœud pour assurer la cohérence.</li></ol><p>Vous trouverez ci-dessous la comparaison de la consommation de temps de sauvegarde pour le même jeu de données:</p><p><strong>Taille de la base de données: 267,6 Go</strong></p><p><strong>Taille de l'index: &amp;lt;1 Mo</strong> (car il était uniquement sur _id pour les tests)</p><pre><code>demo:PRIMARY&gt; db.runCommand({dbStats: 1, scale: 1024*1024*1024})
{
        &quot;db&quot; : &quot;test&quot;,
        &quot;collections&quot; : 1,
        &quot;views&quot; : 0,
        &quot;objects&quot; : 137029,
        &quot;avgObjSize&quot; : 2097192,
        &quot;dataSize&quot; : 267.6398703530431,
        &quot;storageSize&quot; : 13.073314666748047,
        &quot;numExtents&quot; : 0,
        &quot;indexes&quot; : 1,
        &quot;indexSize&quot; : 0.0011749267578125,
        &quot;scaleFactor&quot; : 1073741824,
        &quot;fsUsedSize&quot; : 16.939781188964844,
        &quot;fsTotalSize&quot; : 49.98826217651367,
        &quot;ok&quot; : 1,
        ...
}
demo:PRIMARY&gt;
</code></pre><p>==============================</p><ol><li><strong>Serveur Percona pour la sauvegarde à chaud de MongoDB</strong> :</li></ol><p>Syntaxe :</p><pre><code>&gt; use admin
switched to db admin
&gt; db.runCommand({createBackup: 1, backupDir: &quot;/my/backup/data/path&quot;})
{ &quot;ok&quot; : 1 }
</code></pre><p><strong>Conseil de bonne pratique</strong> : Le chemin de sauvegarde « backupDir » doit être absolu. Il prend également en charge le stockage des sauvegardes sur le système de fichiers et les compartiments AWS S3.</p><pre><code>[root@ip-172-31-37-92 tmp]# time mongo  &lt; hot.js
Percona Server for MongoDB shell version v4.2.8-8
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb
Implicit session: session { &quot;id&quot; : UUID(&quot;c9860482-7bae-4aae-b0e7-5d61f8547559&quot;) }
Percona Server for MongoDB server version: v4.2.8-8
switched to db admin
{
        &quot;ok&quot; : 1,
        ...
}
bye
real    3m51.773s
user    0m0.067s
sys     0m0.026s
[root@ip-172-31-37-92 tmp]# ls
hot  hot.js  mongodb-27017.sock  nohup.out  systemd-private-b8f44077314a49899d0a31f99b31ed7a-chronyd.service-Qh7dpD  tmux-0
[root@ip-172-31-37-92 tmp]# du -sch hot
15G     hot
15G     total
</code></pre><p>Notez que le temps pris par « Percona Hot Backup» n'était que de 4 minutes environ.</p><p>Ceci est très utile lors de la reconstruction d'un nœud ou de la création de nouvelles instances / clusters avec le même jeu de données. La meilleure partie est qu'il ne compromet pas les performances avec le verrouillage des écritures ou d'autres performances.</p><p><strong>Conseil de bonne pratique</strong> : il est recommandé de l'exécuter contre les secondaires.</p><p><strong>2</strong>.<strong>Instantané du système de fichiers</strong> :</p><p>Le temps approximatif nécessaire à la réalisation de l'instantané n'était que de 4 minutes.</p><pre><code>[root@ip-172-31-37-92 ~]# aws ec2 describe-snapshots  --query &quot;sort_by(Snapshots, &amp;StartTime)[-1].{SnapshotId:SnapshotId,StartTime:StartTime}&quot;
{
    &quot;SnapshotId&quot;: &quot;snap-0f4403bc0fa0f2e9c&quot;,
    &quot;StartTime&quot;: &quot;2020-08-26T12:26:32.783Z&quot;
}
</code></pre><pre><code>[root@ip-172-31-37-92 ~]# aws ec2 describe-snapshots \
&gt; --snapshot-ids snap-0f4403bc0fa0f2e9c
{
    &quot;Snapshots&quot;: [
        {
            &quot;Description&quot;: &quot;This is my snapshot backup&quot;,
            &quot;Encrypted&quot;: false,
            &quot;OwnerId&quot;: &quot;021086068589&quot;,
            &quot;Progress&quot;: &quot;100%&quot;,
            &quot;SnapshotId&quot;: &quot;snap-0f4403bc0fa0f2e9c&quot;,
            &quot;StartTime&quot;: &quot;2020-08-26T12:26:32.783Z&quot;,
            &quot;State&quot;: &quot;completed&quot;,
            &quot;VolumeId&quot;: &quot;vol-0def857c44080a556&quot;,
            &quot;VolumeSize&quot;: 50
        }
    ]
}
</code></pre><p><strong>3</strong>. <strong>Mongodump :</strong></p><pre><code>[root@ip-172-31-37-92 ~]# time nohup mongodump -d test -c collG -o /mongodump/ &amp;
[1] 44298
[root@ip-172-31-37-92 ~]# sed -n '1p;$p' nohup.out
2020-08-26T12:36:20.842+0000    writing test.collG to /mongodump/test/collG.bson
2020-08-26T12:51:08.832+0000    [####....................]  test.collG  27353/137029  (20.0%) 
</code></pre><p><strong>Résultats</strong> : comme vous pouvez le voir dans cet exemple rapide utilisant le même ensemble de données - les méthodes de capture instantanée au niveau du système de fichiers et de Percona Server pour MongoDB Hot Backup n'ont pris que 3 à 5 minutes. Cependant, « mongodump » a pris près de 15 minutes pour seulement 20% de la décharge. Par conséquent, la vitesse de sauvegarde des données avec mongodump est certainement très lente par rapport aux deux autres options discutées. C'est là que la compression s2 et les threads parallélisés de Percona Backup pour MongoDB peuvent aider.</p><p><strong>Conclusion</strong></p><p>La meilleure méthode pour effectuer les sauvegardes dépend de plusieurs facteurs tels que le type d'infrastructure, l'environnement, les ressources disponibles, la taille du jeu de données, la charge, etc. Cependant, la cohérence et la complexité jouent également un rôle majeur lors de la sauvegarde des systèmes de base de données distribués.</p><p>En général, pour les petites instances, de simples sauvegardes logiques via mongodump conviennent. Lorsque vous atteignez des tailles de base de données un peu plus grandes au-dessus d'environ 100G, utilisez des méthodes de sauvegarde telles que <strong><a href=https://www.percona.com/software/mongodb/percona-backup-for-mongodb>Percona Backup pour MongoDB</a></strong> qui incluent des sauvegardes incrémentielles et capturent les oplogs afin de pouvoir effectuer des récupérations ponctuelles et minimiser les pertes de données potentielles.</p><p>PBM vous permet de sauvegarder partout - dans le nuage ou on-prem, il peut gérer vos sauvegardes plus grandes, et il est optimisé pour avoir un impact minimal sur les performances de votre production. Le PBM est également plus rapide grâce à l'utilisation de la méthode de compression «s2» et à l'utilisation de threads parallélisés. Enfin, PBM peut surmonter les problèmes de cohérence souvent rencontrés avec le jeu de réplicas et les clusters partitionnés en capturant les modifications dans le journal d'opération.</p><p>Pour les systèmes très volumineux, c'est-à-dire une fois que vous avez atteint environ 1To ou plus, vous devriez chercher à utiliser des sauvegardes d'instantanés au niveau du système de fichiers physique. Un outil disponible pour le faire en open-source est le <a href=https://www.percona.com/software/mongodb/percona-server-for-mongodb>Percona Serveur pour MongoDB</a>. Il a la fonctionnalité intégrée de sauvegarde à chaud intégrée pour le moteur de stockage WiredTiger par défaut et prend à peu près le même temps que les autres instantanés physiques.</p><p><strong><em>Telecharger gratuitement <a href=https://www.percona.com/software/mongodb/percona-backup-for-mongodb>Percona Backup pour MongoDB</a> si vous souhaitez l'essayer</em></strong></p><p>_Page source :<a href=https://www.percona.com/blog/2020/09/18/mongodb-backup-best-practices/>Percona</a></p><ul class=pa0><li class=list><a href=/tags/mongodb class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MongoDB</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2021</a><div></div></div></footer></body></html>