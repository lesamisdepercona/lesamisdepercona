<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>PostgreSQL 14 et Authentification SCRAM. Dois-je migrer vers SCRAM? | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="L'authentification SCRAM n'est pas quelque chose de nouveau dans PostgreSQL. Nous traitons dans cet article les questions fréquemment posées pour une prise de conscience rapide"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="PostgreSQL 14 et Authentification SCRAM. Dois-je migrer vers SCRAM?"><meta property="og:description" content="L'authentification SCRAM n'est pas quelque chose de nouveau dans PostgreSQL. Nous traitons dans cet article les questions fréquemment posées pour une prise de conscience rapide"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/postgresql14-authentification-dois-je-migrer-vers-scram/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail2022/article11.jpg"><meta property="article:published_time" content="2022-03-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-10T00:00:00+00:00"><meta itemprop=name content="PostgreSQL 14 et Authentification SCRAM. Dois-je migrer vers SCRAM?"><meta itemprop=description content="L'authentification SCRAM n'est pas quelque chose de nouveau dans PostgreSQL. Nous traitons dans cet article les questions fréquemment posées pour une prise de conscience rapide"><meta itemprop=datePublished content="2022-03-10T00:00:00+00:00"><meta itemprop=dateModified content="2022-03-10T00:00:00+00:00"><meta itemprop=wordCount content="1616"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail2022/article11.jpg"><meta itemprop=keywords content="PostgreSQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail2022/article11.jpg"><meta name=twitter:title content="PostgreSQL 14 et Authentification SCRAM. Dois-je migrer vers SCRAM?"><meta name=twitter:description content="L'authentification SCRAM n'est pas quelque chose de nouveau dans PostgreSQL. Nous traitons dans cet article les questions fréquemment posées pour une prise de conscience rapide"><script async src="https://www.googletagmanager.com/gtag/js?id=G-W9SYN1YL24"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-W9SYN1YL24');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-203534013-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-203534013-1');</script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/postgresql14-authentification-dois-je-migrer-vers-scram/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/postgresql14-authentification-dois-je-migrer-vers-scram/&text=PostgreSQL%2014%20et%20Authentification%20SCRAM.%20Dois-je%20migrer%20vers%20SCRAM?" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/postgresql14-authentification-dois-je-migrer-vers-scram/&title=PostgreSQL%2014%20et%20Authentification%20SCRAM.%20Dois-je%20migrer%20vers%20SCRAM?" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">PostgreSQL 14 et Authentification SCRAM. Dois-je migrer vers SCRAM?</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2022-03-10T00:00:00Z>March 10, 2022</time>
<span class="f6 mv4 dib tracked">- 8 minutes read</span>
<span class="f6 mv4 dib tracked">- 1616 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p><img src=/thumbnail2022/article11.jpg alt=thumbnail></p><p>Récemment, quelques utilisateurs de PostgreSQL ont signalé avoir eu des échecs de connexion après avoir passés à PostgreSQL 14.</p><p>“ <em>Pourquoi est-ce que j&rsquo;obtiens l&rsquo;erreur <strong>FATAL : l&rsquo;authentification du mot de passe a échoué pour un utilisateur</strong> dans le nouveau serveur ?</em> » est devenue l&rsquo;une des questions les plus intrigantes.</p><p>Au moins dans un cas, c&rsquo;était un peu surprenant que le message d&rsquo;application soit le suivant :</p><p><strong>FATAL : La connexion à la base de données a échoué : la connexion au serveur sur «localhost» (::1 ), le port 5432 a échoué : fe_sendauth : aucun mot de passe fourni</strong></p><p>La raison de ces erreurs est que les valeurs par défaut pour le chiffrement du mot de passe sont modifiées dans les nouvelles versions de PostgreSQL vers l&rsquo;authentification SCRAM. Même si le dernier ne semble rien directement lié à SCRAM, oh oui, un script de post-installation a échoué qui cherchait &ldquo;md5&rdquo;.</p><p>L&rsquo;authentification SCRAM n&rsquo;est pas quelque chose de nouveau dans PostgreSQL . Il était là depuis PostgreSQL 10 mais n&rsquo;a jamais affecté DBA en général car cela n&rsquo;a jamais été la valeur par défaut. Il s&rsquo;agissait d&rsquo;une fonctionnalité opt-in en modifiant explicitement les paramètres par défaut. Ceux qui font un opt-in comprennent généralement et le font intentionnellement, et cela n&rsquo;a jamais causé de problème. La communauté PostgreSQL était réticente à en faire une méthode de choix pendant des années car de nombreuses bibliothèques client/application n&rsquo;étaient pas prêtes pour l&rsquo;authentification SCRAM.</p><p>Mais cela change dans PostgreSQL 14. Avec PostgreSQL 9.6 qui n&rsquo;est plus pris en charge, le paysage change. Maintenant, nous nous attendons à ce que toutes les anciennes bibliothèques clientes soient mises à niveau et l&rsquo;authentification SCRAM devient la principale méthode d&rsquo;authentification par mot de passe. Mais, ceux qui l&rsquo;ignorent complètement vont être accueillis par une surprise un jour ou l&rsquo;autre. Le but de cet article est de créer une prise de conscience rapide pour ceux qui ne le sont pas encore et de répondre à certaines des questions fréquemment posées.</p><h2 id=quest-ce-que-lauthentification-scram>Qu&rsquo;est-ce que l&rsquo;authentification SCRAM ?</h2><p>En termes simples, la base de <strong>données</strong> <strong>le client et le serveur se prouvent et se convainquent qu&rsquo;ils connaissent le mot de passe sans échanger le mot de passe ou le hashage du mot de passe</strong> . Oui, c&rsquo;est possible en faisant un défi et des réponses salés, SCRAM-SHA-256, comme spécifié par <a href=https://datatracker.ietf.org/doc/html/rfc7677>RFC 7677 </a>. Cette façon de stocker, de communiquer et de vérifier les mots de passe rend très difficile la rupture d&rsquo;un mot de passe.</p><p>Cette méthode est plus résistante à :</p><ul><li>dictionnaire attaques</li><li>Rejouer attaques</li><li>Hashes volés</li></ul><p>Dans l&rsquo;ensemble, il devient très difficile de casser une authentification par mot de passe.</p><h2 id=quest-ce-qui-a-changé-avec-le-temps>Qu&rsquo;est-ce qui a changé avec le temps ?</h2><h3 id=liaison-de-canal>Liaison de canal</h3><p>L&rsquo;authentification n&rsquo;est qu&rsquo;une partie de la communication sécurisée. Après l&rsquo;authentification, un serveur malveillant au milieu peut potentiellement prendre le relais et tromper la connexion client. PostgreSQL 11 a introduit SCRAM-SHA-256-PLUS qui prend en charge la liaison de canal. C&rsquo;est pour s&rsquo;assurer qu&rsquo;il n&rsquo;y a pas de serveur malveillant agissant comme un vrai serveur OU faisant une attaque de l&rsquo;homme du milieu.</p><p>À partir de PostgreSQL 13, un client peut demander et même insister sur la liaison de canal.</p><p>Par exemple :</p><pre><code>psql -U postgres -h c76pri channel_binding=prefer
or
psql -U postgres -h c76pri channel_binding=require
</code></pre><p>La liaison de canal fonctionne sur SSL/TLS, la configuration SSL/TLS est donc obligatoire pour que la liaison de canal fonctionne.</p><h3 id=définition-du-mot-de-passe-de-cryptage>Définition du mot de passe de cryptage</h3><p>Le <strong>md5</strong> était la seule option disponible pour le chiffrement de mot de passe avant PostgreSQL 10, donc PostgreSQL permet aux paramètres d&rsquo;indiquer que &ldquo;le chiffrement de mot de passe est requis&rdquo; qui est par défaut à md5.</p><pre><code>–Upto PG 13
postgres=# set password_encryption TO ON;
SET
</code></pre><p>Pour la même raison, la déclaration ci-dessus était effectivement la même que :</p><pre><code>postgres=# set password_encryption TO MD5;
SET
</code></pre><p>Nous pourrions même utiliser &ldquo;vrai&rdquo;, &ldquo;1&rdquo;, &ldquo;oui&rdquo; au lieu de &ldquo;on&rdquo; comme valeur équivalente.</p><p>Mais maintenant, nous avons plusieurs méthodes de cryptage et &ldquo;ON&rdquo; ne transmet pas vraiment ce que nous voulons vraiment. Ainsi, à partir de PostgreSQL 14, le système s&rsquo;attend à ce que nous spécifions la méthode de chiffrement.</p><pre><code>postgres=# set password_encryption TO 'scram-sha-256';
SET
</code></pre><pre><code>postgres=# set password_encryption TO 'md5';
SET
</code></pre><p>Toute tentative d&rsquo;utiliser &ldquo;on&rdquo;/&ldquo;true&rdquo;, &ldquo;yes&rdquo; sera rejetée avec une erreur.</p><pre><code>–-From PG 14
postgres=# set password_encryption TO 'on';
ERROR:  invalid value for parameter &quot;password_encryption&quot;: &quot;on&quot;
HINT:  Available values: md5, scram-sha-256.
</code></pre><p>Veuillez donc vérifier vos scripts et vous assurer qu&rsquo;ils n&rsquo;ont pas l&rsquo;ancienne méthode &ldquo;d&rsquo;activation&rdquo; du chiffrement.</p><h2 id=quelque-question-fréquemment-posées>Quelque Question Fréquemment posées</h2><ol><li><p><strong>Ma sauvegarde et ma restauration logiques sont-elles affectées ?</strong>
Sauvegarde et restauration logique de PostgreSQL globals ( pg_dumpall ) n&rsquo;affectera pas l&rsquo;authentification SCRAM, le même mot de passe devrait fonctionner après la restauration. En fait, il sera intéressant de rappeler que l&rsquo;authentification SCRAM est plus résistante aux changements. Par exemple, si nous renommons un USER, l&rsquo;ancien mot de passe MD5 ne fonctionnera plus, car la façon dont PostgreSQL génère le MD5 utilise également le nom d&rsquo;utilisateur.</p><p><code>postgres =# ALTER USER jobin1 RENOMMER EN jobin ; AVIS : Le mot de passe MD5 a été effacé en raison du rôle renameALTER ROLE</code></p><p>Comme le NOTICE l&rsquo;indique, le hashage du mot de passe dans pg_authid sera effacé car l&rsquo;ancien n&rsquo;est plus valide. Mais ce ne sera pas le cas avec l&rsquo;authentification SCRAM, car nous pouvons renommer les utilisateurs sans affecter le mot de passe.</p><p><code>postgres =# ALTER USER jobin RENOMMER EN jobin1 ; MODIFIER LE RÔLE</code></p></li><li><p><strong>La méthode de cryptage existante/ancienne (md5) était une grande vulnérabilité. Y avait-il un gros risque ?</strong>
Cette inquiétude vient principalement du nom &ldquo;MD5&rdquo; qui est bien trop idiot pour le matériel moderne. La façon dont PostgreSQL utilise md5 est différente, ce n&rsquo;est pas seulement le hashage du mot de passe, mais il considère également le nom d&rsquo;utilisateur. De plus, il est communiqué sur le réseau après avoir préparé un hashage avec un salt aléatoire fourni par le serveur. Effectivement ce qui est communiqué sera différent du hashage du mot de passe, il n&rsquo;est donc pas trop vulnérable. Mais sujet aux attaques par dictionnaire et aux fuites de problèmes de hashage du mot de passe du nom d&rsquo;utilisateur.</p></li><li><p><strong>Les nouvelles annonces d&rsquo;authentification scram sont-elles complexes à authentifier ? Est-ce que ma demande de connexion va prendre plus de temps ?</strong>
Le protocole filaire SCRAM est très efficace et n&rsquo;est pas connu pour provoquer de dégradation du temps de connexion. De plus, par rapport aux autres surcoûts de la gestion des connexions côté serveur, le surcoût créé par SCRAM devient très négligeable</p></li><li><p><strong>Est-il obligatoire d&rsquo;utiliser l&rsquo;authentification SCRAM depuis PostgreSQL 14 et de forcer tous mes comptes utilisateurs à y basculer ?</strong>
Absolument pas, seules les valeurs par défaut sont modifiées. L&rsquo;ancienne méthode md5 est toujours une méthode valide qui fonctionne très bien, et si l&rsquo;accès à l&rsquo;environnement PostgreSQL est restreint par des règles de pare-feu/ hba , il y a déjà moins de risques à utiliser md5.</p></li><li><p><strong>Pourquoi est-ce que j&rsquo;obtiens l&rsquo;erreur « : FATAL : l&rsquo;authentification du mot de passe a échoué pour l&rsquo;utilisateur » lorsque je suis passé à PostgreSQL 14 ?</strong>
La raison la plus probable est les entrées pg_hba.conf . Si nous spécifions &ldquo;md5&rdquo; comme méthode d&rsquo;authentification, PostgreSQL autorisera également l&rsquo;authentification SCRAM. Mais l&rsquo;inverse ne fonctionnera pas. Lorsque vous avez créé l&rsquo;environnement PostgreSQL 14, il peut très probablement avoir &ldquo;scram-sha-256&rdquo; comme méthode d&rsquo;authentification. Dans certains des packages PostgreSQL, le script d&rsquo;installation le fait automatiquement pour vous. Dans le cas où l&rsquo;authentification fonctionne à partir des outils client PostgreSQL et non à partir de l&rsquo;application, veuillez <a href=https://wiki.postgresql.org/wiki/List_of_drivers>vérifier la version du pilote</a> et vérifier la portée de la mise à niveau</p></li><li><p><strong>Pourquoi ai-je d&rsquo;autres types d&rsquo;erreurs d&rsquo;authentification ?</strong>
Les raisons les plus probables sont les scripts de post-installation. Il est courant dans de nombreuses organisations d&rsquo;utiliser des outils DevOps ( Ansible /Chef) ou même des scripts shell pour effectuer les personnalisations post-installation. Beaucoup d&rsquo;entre eux feront une gamme de choses qui impliquent des étapes telles que set password_encryption TO ON; ou même la modification de pg_hba.conf en utilisant sed , qui devrait échouer s&rsquo;il essaie de modifier une entrée qui n&rsquo;y est plus.</p></li></ol><h2 id=pourquoi-devrais-je-men-soucier-et-que-faire>Pourquoi devrais-je m&rsquo;en soucier et que faire</h2><p>Tout ce qui commence par les scripts d&rsquo;automatisation/déploiement, les outils, les connexions d&rsquo;application et les poolers de connexion peut potentiellement se casser. L&rsquo;un des principaux arguments pour retarder ce changement jusqu&rsquo;à PostgreSQL 14 est que la version la plus ancienne prise en charge (9.6) ne sera bientôt plus prise en charge. C&rsquo;est donc le bon moment pour inspecter vos environnements pour voir si l&rsquo;un de ces environnements possède d&rsquo;anciennes bibliothèques PostgreSQL (9.6 ou antérieures) et avoir un plan pour la mise à niveau, car les bibliothèques PostgreSQL de l&rsquo;ancienne version ne peuvent pas gérer les négociations SCRAM.</p><p>En résumé, avoir un bon plan pour migrer aidera, même si ce n&rsquo;est pas urgent.</p><ol><li>Inspectez les environnements et les pilotes d&rsquo;application pour voir si l&rsquo;un d&rsquo;entre eux utilise encore d&rsquo;anciennes versions des bibliothèques client PostgreSQL et mettez-les à niveau si nécessaire.
Veuillez vous référer à : <a href=https://wiki.postgresql.org/wiki/List_of_drivers>https://wiki.postgresql.org/wiki/List_of_drivers</a>
Encourager / Piloter la mise à niveau des bibliothèques clientes avec un calendrier</li><li>Si l&rsquo;environnement existant utilise md5, encouragez les utilisateurs à passer à l&rsquo;authentification
SCRAM . N&rsquo;oubliez pas que la méthode d&rsquo;authentification mentionnée comme &ldquo;md5&rdquo; dans pg_hba.conf continuera à fonctionner pour l&rsquo;authentification SCRAM et MD5 dans PostgreSQL 14 également.</li><li>Profitez de chaque occasion pour tester et migrer l&rsquo;automatisation, les pooleurs de connexions et d&rsquo;autres infrastructures vers l&rsquo;authentification SCRAM.</li></ol><p>En modifiant l&rsquo;authentification par défaut, la communauté PostgreSQL montre une direction claire pour l&rsquo;avenir.</p><p><strong>Percona Distribution for PostgreSQL fournit les meilleurs composants entreprise de la communauté open source, dans une distribution unique, conçue et testée pour fonctionner ensemble.</strong></p><p><a href=https://www.percona.com/software/postgresql-distribution>Téléchargez Percona Distribution pour PostgreSQL</a></p><p>Source : <a href=https://www.percona.com/blog/postgresql-14-and-recent-scram-authentication-changes-should-i-migrate-to-scram/>Percona</a></p><ul class=pa0><li class=list><a href=/tags/postgresql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">PostgreSQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2022</a><div></div></div></footer></body></html>