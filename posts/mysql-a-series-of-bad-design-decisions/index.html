<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>MySQL - Une série de mauvaises décisions de conception | Lesamisdepercona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="MySQL dispose certainement plusieurs atouts particuliers, sinon, ce ne serait pas la base de données Open Source la plus populaire au monde (selon DB-Engines). Cependant, je vois des décisions ou des comportements qui sont dus à des mauvaises conceptions. Beaucoup d’entre eux reposent sur de nombreux raisonnements historiques et sont peut-être toujours là parce que les ressources allouées au nettoyage du code sont insuffisantes.
Je suis passionné par l&rsquo;observabilité, en particulier lorsqu&rsquo;il s&rsquo;agit de comprendre les performances du système."><meta name=generator content="Hugo 0.82.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/fredel/ananke/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css><meta property="og:title" content="MySQL - Une série de mauvaises décisions de conception"><meta property="og:description" content="MySQL dispose certainement plusieurs atouts particuliers, sinon, ce ne serait pas la base de données Open Source la plus populaire au monde (selon DB-Engines). Cependant, je vois des décisions ou des comportements qui sont dus à des mauvaises conceptions. Beaucoup d’entre eux reposent sur de nombreux raisonnements historiques et sont peut-être toujours là parce que les ressources allouées au nettoyage du code sont insuffisantes.
Je suis passionné par l&rsquo;observabilité, en particulier lorsqu&rsquo;il s&rsquo;agit de comprendre les performances du système."><meta property="og:type" content="article"><meta property="og:url" content="https://dbazhenov.github.io/fredel/posts/mysql-a-series-of-bad-design-decisions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-08T11:43:01+04:00"><meta property="article:modified_time" content="2021-04-08T11:43:01+04:00"><meta itemprop=name content="MySQL - Une série de mauvaises décisions de conception"><meta itemprop=description content="MySQL dispose certainement plusieurs atouts particuliers, sinon, ce ne serait pas la base de données Open Source la plus populaire au monde (selon DB-Engines). Cependant, je vois des décisions ou des comportements qui sont dus à des mauvaises conceptions. Beaucoup d’entre eux reposent sur de nombreux raisonnements historiques et sont peut-être toujours là parce que les ressources allouées au nettoyage du code sont insuffisantes.
Je suis passionné par l&rsquo;observabilité, en particulier lorsqu&rsquo;il s&rsquo;agit de comprendre les performances du système."><meta itemprop=datePublished content="2021-04-08T11:43:01+04:00"><meta itemprop=dateModified content="2021-04-08T11:43:01+04:00"><meta itemprop=wordCount content="1115"><meta itemprop=keywords content="mysql,"><meta name=twitter:card content="summary"><meta name=twitter:title content="MySQL - Une série de mauvaises décisions de conception"><meta name=twitter:description content="MySQL dispose certainement plusieurs atouts particuliers, sinon, ce ne serait pas la base de données Open Source la plus populaire au monde (selon DB-Engines). Cependant, je vois des décisions ou des comportements qui sont dus à des mauvaises conceptions. Beaucoup d’entre eux reposent sur de nombreux raisonnements historiques et sont peut-être toujours là parce que les ressources allouées au nettoyage du code sont insuffisantes.
Je suis passionné par l&rsquo;observabilité, en particulier lorsqu&rsquo;il s&rsquo;agit de comprendre les performances du système."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://dbazhenov.github.io/fredel/images/Bad-Design-MySQL-367x205.png)><div class="pb3-m pb6-l bg-black-60"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/fredel/ class="f3 fw2 hover-white no-underline white-90 dib">Lesamisdepercona</a><div class="flex-l items-center"></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">MySQL - Une série de mauvaises décisions de conception</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://dbazhenov.github.io/fredel/posts/mysql-a-series-of-bad-design-decisions/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://dbazhenov.github.io/fredel/posts/mysql-a-series-of-bad-design-decisions/&text=MySQL%20-%20Une%20s%c3%a9rie%20de%20mauvaises%20d%c3%a9cisions%20de%20conception" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://dbazhenov.github.io/fredel/posts/mysql-a-series-of-bad-design-decisions/&title=MySQL%20-%20Une%20s%c3%a9rie%20de%20mauvaises%20d%c3%a9cisions%20de%20conception" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">MySQL - Une série de mauvaises décisions de conception</h1><time class="f6 mv4 dib tracked" datetime=2021-04-08T11:43:01+04:00>April 8, 2021</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>MySQL dispose certainement plusieurs atouts particuliers, sinon, ce ne serait pas la base de données Open Source la plus populaire au monde (selon <a href=https://db-engines.com/en/ranking>DB-Engines</a>). Cependant, je vois des décisions ou des comportements qui sont dus à des mauvaises conceptions. Beaucoup d’entre eux reposent sur de nombreux raisonnements historiques et sont peut-être toujours là parce que les ressources allouées au nettoyage du code sont insuffisantes.</p><p>Je suis passionné par l&rsquo;observabilité, en particulier lorsqu&rsquo;il s&rsquo;agit de comprendre les performances du système. L&rsquo;une des données les plus importantes pour comprendre les performances de MySQL est de comprendre sa discorde de verrous (mutexes, rwlocks, etc.).</p><p>La «meilleure» façon de comprendre les verrous dans MySQL est le schéma de performance. Malheureusement, le profilage de verrouillage est désactivé par défaut dans le schéma de performances car il entraîne une surcharge assez importante à tel point que vous ne l’utilisez probablement pas en production à tout moment.</p><p>Si vous cherchez à obtenir des informations mutex qui sont toujours disponibles en MySQL, vous pouvez les obtenir à partir du moteur de stockage InnoDB (ce qui est souvent assez pertinent, car c&rsquo;est là que la plupart des conflits se produisent).</p><p>Vous pouvez regarder dans le résultat de <strong>SHOW ENGINE INNODB STATUS</strong> - en particulier dans la section SEMAPHORES:</p><pre><code>----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 490020789
--Thread 140407582807808 has waited at row0ins.cc line 2412 for 0 seconds the semaphore:
S-lock on RW-latch at 0x7fa0159bd6f0 created in file buf0buf.cc line 785
a writer (thread id 140407910762240) has reserved it in mode  exclusive
number of readers 0, waiters flag 1, lock_word: 0
Last time read locked in file row0ins.cc line 2412
Last time write locked in file /mnt/workspace/percona-server-8.0-debian-binary/label_exp/min-bionic-x64/test/percona-server-8.0.18-9/storage/innobase/include/mtr0mtr.ic line 142
--Thread 140386577712896 has waited at row0ins.cc line 2412 for 0 seconds the semaphore:
S-lock on RW-latch at 0x7fa0159bd6f0 created in file buf0buf.cc line 785
a writer (thread id 140407910762240) has reserved it in mode  exclusive
number of readers 0, waiters flag 1, lock_word: 0
Last time read locked in file row0ins.cc line 2412
Last time write locked in file /mnt/workspace/percona-server-8.0-debian-binary/label_exp/min-bionic-x64/test/percona-server-8.0.18-9/storage/innobase/include/mtr0mtr.ic line 142
</code></pre><p>Cette section fournit des informations sur les mutex attendus ainsi que des informations sur les temps d&rsquo;attente qui peuvent être très utiles. Malheureusement, ces informations sont fournies sous une forme qui n&rsquo;est pas facilement analysable et ne peut être récupérée qu&rsquo;avec l’intégralité du résultat de <strong>SHOW ENGINE INNODB STATUS</strong> entraînant ainsi une charge supplémentaire qui le rend inadéquat à l&rsquo;échantillonnage répétitif.</p><p>Savoir pourquoi cette information n&rsquo;a jamais été rendue accessible avec une table <code>INFORMATION_SCHEMA</code> est un casse-tête. Est-ce parce que l’idée était que <code>PERFORMANCE_SCHEMA</code> devrait être le seul et unique outil d’observabilité, même lorsque l’équipe d’ingénierie MySQL ne peut pas le faire fonctionner avec une surcharge acceptable?</p><p>Mais attendez, dites-vous &mldr; il existe un meilleur moyen - vous pouvez utiliser <strong>SHOW ENGINE INNODB MUTEX</strong>  pour obtenir un résumé des statistiques:</p><pre><code>mysql&gt; SHOW ENGINE INNODB MUTEX;
+--------+----------------------------+-----------------+
| Type   | Name                       | Status          |
+--------+----------------------------+-----------------+
| InnoDB | rwlock: dict0dict.cc:2454  | waits=138       |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=545       |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=124       |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=110       |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=134       |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=132       |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=5317      |
| InnoDB | rwlock: dict0dict.cc:2454  | waits=538       |

…
| InnoDB | rwlock: hash0hash.cc:171   | waits=219       |
| InnoDB | rwlock: hash0hash.cc:171   | waits=291       |
| InnoDB | rwlock: hash0hash.cc:171   | waits=290       |
| InnoDB | rwlock: hash0hash.cc:171   | waits=312       |
| InnoDB | rwlock: hash0hash.cc:171   | waits=281       |
| InnoDB | rwlock: hash0hash.cc:171   | waits=226       |
| InnoDB | rwlock: hash0hash.cc:171   | waits=327       |
| InnoDB | sum rwlock: buf0buf.cc:785 | waits=138699546 |
+--------+----------------------------+-----------------+
332 rows in set (0.59 sec)
</code></pre><p>Cette commande ne fournit pas les mêmes informations (elle indique le nombre d&rsquo;attentes, et non pas l&rsquo;attente existante) mais elle est utile. Le problème avec cette commande est qu&rsquo;elle semble avoir été spécialement conçue pour être la moins utile possible. Regardez qu’il y a beaucoup de doublons dans &ldquo;Name&rdquo;. En effet, il existe plusieurs instances du même type de mutex. En general, lorsque vous souhaitez comprendre le type de conflit auquel vous êtes confronté, vous souhaitez totaliser la somme des nombre d’attentes en le regroupant par nom, et malheureusement, vous ne pouvez pas le faire avec les commandes SHOW.</p><p>Encore plus étrange est le choix de la syntaxe waits = N et l&rsquo;attribution d&rsquo;un nom à une colonne «Statut» là où la conception de la base de données relationnelle l’aurait appelée «Waits».</p><p>J&rsquo;aurais également préféré voir le nom de l&rsquo;objet de synchronisation ici au lieu de la ligne de code source car il est généralement beaucoup plus descriptif. MariaDB le fait, et il le rend également disponible sous <a href=https://mariadb.com/kb/en/information-schema-innodb_mutexes-table/>forme de table de d&rsquo;informations innodb_mutex</a>.</p><p>Enfin, notez à quel point cette commande est lente (lire: coûteuse): 0,6 seconde sur un pool de mémoire tampon de 80 Go. La raison en est qu&rsquo;il capture les conflits de mutex sur les pages du pool de mémoire tampon. C&rsquo;es indispensable pour identifier les conflits relatifs à chaque page, mais cela nécessite également l&rsquo;agrégation des informations pour des millions d&rsquo;objets potentiels, ce qui prend du temps.</p><p>Je pense que la table INFORMATION_SCHEMA pourrait également être plus adaptée pour afficher ces informations.</p><p>Alors, nous ne pouvons donc pas exécuter SELECT sur la table INFORMATION_SCHEMA pour obtenir les données sous une forme facilement assimilable, mais peut-être devrions-nous écrire une procédure stockée à la place?</p><p>Cela nous amène à un autre problème de conception. Bien que vous puissiez facilement itérer SELECT dans une procédure stockée, cela ne fonctionne pas pour les commandes SHOW. Il y avait probablement une bonne raison pratique à cette limitation, mais elle n&rsquo;est pas du tout conviviale.</p><p>Quand rien ne va, nous pouvons toujours recourir aux scripts Shell pour résoudre le problème:</p><pre><code>root@rocky:~# mysql -BNe &quot;SHOW ENGINE INNODB MUTEX&quot; | awk -F'\t' '{split($3, waits, &quot;=&quot;); out[$2]+=waits[2];} END { for(el in out) printf &quot;%s\t%d\n&quot;, el, out[el] } '
sum rwlock: buf0buf.cc:785      138984320
rwlock: btr0sea.cc:202  226767645
rwlock: trx0purge.cc:222        13
rwlock: ibuf0ibuf.cc:543        345822
rwlock: dict0dict.cc:2454       1958468
rwlock: dict0dict.cc:1042       66610
rwlock: fil0fil.cc:3150 1064444
rwlock: hash0hash.cc:171        37536
rwlock: dict0dict.cc:330        131
</code></pre><p>Cependant, si votre base de données vous oblige à proceder ainsi pour regrouper les informations ordinaires c&rsquo;est qu&rsquo;il y a quelquechose qui ne va pas!</p><p><strong>Ce dont j&rsquo;aimerais voir?</strong> Je pense que toutes les instructions SHOW doivent être revisées et si elles ne sont pas prévues pour la dépréciation, des informations similaires à ce qu&rsquo;elles fournissent doivent être mises à disposition à partir de tables ou de vues. En fait, ce travail a déjà été effectué pour la plupart des commandes habituelles mais il semble qu&rsquo;il ne soit jamais terminé.</p><ul class=pa0><li class=list><a href=/fredel/tags/mysql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mysql</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://dbazhenov.github.io/fredel>&copy; Lesamisdepercona 2021</a><div></div></div></footer></body></html>