<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Rejouer l'exécution de MySQL avec Record and Replay | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Traduit à partir de l'article de Marcelo Altmann intitulé, Replay the Execution of MySQL With Record and Replay"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Rejouer l'exécution de MySQL avec Record and Replay"><meta property="og:description" content="Traduit à partir de l'article de Marcelo Altmann intitulé, Replay the Execution of MySQL With Record and Replay"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/rejouer-l-execution-de-mysql-avec-rr-record-and-replay/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail/amisdepercona21-00012.jpg"><meta property="article:published_time" content="2021-08-20T11:43:01+04:00"><meta property="article:modified_time" content="2021-08-20T11:43:01+04:00"><meta itemprop=name content="Rejouer l'exécution de MySQL avec Record and Replay"><meta itemprop=description content="Traduit à partir de l'article de Marcelo Altmann intitulé, Replay the Execution of MySQL With Record and Replay"><meta itemprop=datePublished content="2021-08-20T11:43:01+04:00"><meta itemprop=dateModified content="2021-08-20T11:43:01+04:00"><meta itemprop=wordCount content="1298"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail/amisdepercona21-00012.jpg"><meta itemprop=keywords content="MySQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail/amisdepercona21-00012.jpg"><meta name=twitter:title content="Rejouer l'exécution de MySQL avec Record and Replay"><meta name=twitter:description content="Traduit à partir de l'article de Marcelo Altmann intitulé, Replay the Execution of MySQL With Record and Replay"><script async src="https://www.googletagmanager.com/gtag/js?id=G-W9SYN1YL24"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-W9SYN1YL24');</script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/rejouer-l-execution-de-mysql-avec-rr-record-and-replay/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/rejouer-l-execution-de-mysql-avec-rr-record-and-replay/&text=Rejouer%20l%27ex%c3%a9cution%20de%20MySQL%20avec%20Record%20and%20Replay" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/rejouer-l-execution-de-mysql-avec-rr-record-and-replay/&title=Rejouer%20l%27ex%c3%a9cution%20de%20MySQL%20avec%20Record%20and%20Replay" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Rejouer l'exécution de MySQL avec Record and Replay</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-08-20T11:43:01+04:00>August 20, 2021</time>
<span class="f6 mv4 dib tracked">- 7 minutes read</span>
<span class="f6 mv4 dib tracked">- 1298 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p><strong>La chasse aux bugs peut être une tâche fastidieuse, et les logiciels multi-threads ne facilitent pas la tâche.</strong> Les threads seront programmés à des moments différents, les instructions n&rsquo;auront pas de résultats déterministes, et pour reproduire un problème particulier, cela peut nécessiter exactement les mêmes threads, effectuant exactement le même travail, exactement au même moment. Comme vous pouvez l&rsquo;imaginer, ce n&rsquo;est pas si simple.</p><p>Disons que votre base de données tombe en panne ou même qu&rsquo;elle a un décrochage transitoire. Au moment où vous y arrivez, le crash s&rsquo;est produit et vous êtes bloqué en restaurant le service rapidement et en faisant des investigations après coup. Ne serait-il pas agréable de rejouer le travail juste avant ou pendant le crash et de voir exactement ce qui se passait ?</p><p><a href=https://rr-project.org/>Record and Replay</a> est une technique où nous enregistrons l&rsquo;exécution d&rsquo;un programme lui permettant d&rsquo;être rejoué encore et encore produisant le même résultat. Les ingénieurs de Mozilla ont créé RR, et fondamentalement, cet outil open source vous permet d&rsquo;enregistrer l&rsquo;exécution du logiciel et de le rejouer sous le célèbre GDB. </p><p><strong>Un problème de sauvegarde</strong></p><p>Pour démontrer à quel point l&rsquo;outil est puissant, nous expliquerons comment nous l&rsquo;avons utilisé pour réduire le problème de <a href=https://jira.percona.com/browse/PXB-2180>PXB-2180</a> (remerciement spécial à <a href=https://www.percona.com/blog/author/satya-bodapati/>Satya Bodapati</a> , qui a aidé à toutes les recherches internes d&rsquo;InnoDB pour ce bug).</p><p>En résumé, nous avions vu <a href=https://www.percona.com/software/mysql-database/percona-xtrabackup>Percona XtraBackup</a> planter au stade de la préparation (rappelez-vous de toujours tester votre sauvegarde!). Le crash se produisait de manière aléatoire, parfois après le deuxième incrémentiel, parfois après le 10ème incrémentiel, sans motif visible.</p><p>La trace de la pile n&rsquo;était pas non plus toujours la même. Il plantait sur différentes parties d&rsquo;InnoDB , mais ici, nous avions un point commun entre tous les plantages - cela se produisait toujours en essayant d&rsquo;appliquer un enregistrement de journalisation à la même page de blocage et au même identifiant d&rsquo;espace :</p><p>Notre soupçon était que la mise en page de ce bloc divergeait entre MySQL et XtraBackup. Lorsque vous travaillez avec ces types de bug, le plantage est toujours la conséquence de quelque chose qui s&rsquo;est passé plus tôt, par exemple : un plantage sur la sixième sauvegarde incrémentielle pourrait être la conséquence d&rsquo;un problème survenu lors de la quatrième sauvegarde incrémentielle.</p><p>L&rsquo;objectif principal à cette étape est de prouver et d&rsquo;identifier où la mise en page s&rsquo;est détournée.</p><p>Avec ces informations, nous avons exécuté MySQL sous RR et réexécuté la sauvegarde jusqu&rsquo;à ce que nous voyions le même problème lors de la préparation. Nous pouvons maintenant rejouer l&rsquo;exécution de MySQL et vérifier comment ça se présente. Notre idée est de :</p><ol><li>Lire les <a href=https://dev.mysql.com/doc/refman/8.0/en/glossary.html%23glos_lsn#glos_lsn>LSN</a> pour cette même page avant/après chaque préparation de sauvegarde</li><li>Identifier toutes les modifications apportées à m_space = 4294967294 & m_page_no = 5 sur mysqld</li></ol><p>Avant d&rsquo;aller plus loin, nous tenons à expliquer quelques points :</p><ol><li>m_space = 4294967294 correspond au dictionnaire de données MySQL (mysql.ibd) – <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/include/dict0dict.h%23L1146#L1146>dict0dict.h:1146</a></li><li>Sur la page du disque, LSN est stocké au 16e octet de la page avec une taille de 8 octets – <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/include/fil0types.h%23L66#L66>fil0types.h:66</a> </li><li>Les pages sont écrites séquentiellement sur le disque, par exemple, pour la taille de page par défaut de 16 ko, à partir d’octet 1 à 16384 auront les données de la page 0. Celle de l&rsquo;octet entre 16385 et 32768, les données seront dans la page 1, et ainsi de suite.</li><li>Le Frame est une donnée brute d&rsquo;une page – <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/include/buf0buf.h%23L1358#L1358>buf0buf.h:1358</a></li></ol><p><strong>Rejouer l&rsquo;exécution</strong></p><p>Pour commencer, lisons le LSN que nous avons sur mysql.ibd pour la page cinq avant la sauvegarde. Nous utiliserons od (consultez man od pour plus d&rsquo;informations) et les informations expliquées ci-dessus.</p><p>Vérifions s&rsquo;il correspond à un tampon LSN de mysqld. Pour cela nous allons ajouter un point d&rsquo;arrêt conditionnel sur le replay de l&rsquo;exécution de MySQL à la fonction buf_flush_note_modification : </p><p>Nous pouvons voir le tampon LSN d&rsquo;avant la préparation de la sauvegarde complète et le premier tampon de relecture de la session match. Il est temps de préparer la sauvegarde, d&rsquo;avancer l&rsquo;exécution de la relecture et de revérifier :</p><p>Même tampon LSN à tous les deux, serveur et sauvegarde. Il est temps de passer à autre chose et de commencer à appliquer les incrémentiels :</p><p>Encore une fois, nous avons le même tampon LSN des deux côtés. Passage à l&rsquo;incrémentiel suivant :</p><p>L’incrémentiel 02 s’appliquent et correspondent au LSN à partir de mysqld. Continuons jusqu&rsquo;à ce que nous trouvions une incompatibilité :</p><p>Ok, ici nous avons quelque chose. Les fichiers de sauvegarde passent de 0x01474d3f à 0x015fa326 lors de l&rsquo;application de l’incrémentiel quatre tandis que le serveur est passé de 0x01474d3f à 0x019f3fc9. Peut-être avons-nous manqué un autre endroit où nous pouvons mettre à jour le tampon LSN d&rsquo;une page? Maintenant, nous sommes à un point d’avance avec notre exécution de relecture du serveur MySQL</p><p><strong>Rejouer l&rsquo;exécution à l&rsquo;envers</strong></p><p>Voici (encore) une autre fonctionnalité très intéressante de RR, elle vous permet de rejouer l&rsquo;exécution à l&rsquo;envers. Pour éliminer la possibilité de manquer un endroit qui met également à jour le LSN de ce bloc, ajoutons un point de surveillance matériel sur l’adresse mémoire block- >frame et inversons l&rsquo;exécution :</p><p>En rejouant l&rsquo;exécution à l&rsquo;envers, nous pouvons voir qu&rsquo;en effet le serveur a changé le LSN de 0x01474d3f à 0x019f3fc9 . Cela confirme que le problème se situe au niveau de la sauvegarde incrémentielle quatre, car le LSN 0x015fa326 que nous voyons à la fin de la sauvegarde incrémentielle quatre n&rsquo;a jamais été un LSN valide lors de l&rsquo;exécution du serveur.</p><p><strong>Cause première</strong></p><p>Maintenant que nous avons limité la portée de six sauvegardes à une seule, les choses vont devenir plus faciles.</p><p>Si nous examinons de près les messages de journal de -prepare de la sauvegarde, nous pouvons voir que le LSN de mysql.ibd correspond au tampon LSN à la fin de la sauvegarde :</p><p>En vérifiant la trace de la pile du problème et en examinant plus en détail le bloc que nous avons analysé, nous pouvons voir qu&rsquo;il s&rsquo;agit de l&rsquo;index innodb_dynamic_metadata:</p><p>Vous vous demandez peut-être d&rsquo;où vient le 66? Cela vient de l&rsquo;examen de la position <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/include/fil0types.h%23L114#L114>FIL_PAGE_DATA</a> + <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/include/page0types.h%23L83#L83>PAGE_INDEX_ID</a> . Cela nous a donné l&rsquo;ID d&rsquo;index 2. C&rsquo;est en dessous de 1024, qui est réservé aux tables du <a href=https://github.com/percona/percona-xtrabackup/blob/8.0/storage/innobase/include/dict0dd.h%23L82#L82>dictionnaire de données</a>. En vérifiant la deuxième table de cette liste, nous pouvons voir qu&rsquo;il s&rsquo;agit de <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/include/dict0dd.h%23L276#L276>innodb_dynamic_metadata</a> . Avec toutes ces informations résumées, nous pouvons regarder ce que fait le serveur à l&rsquo;arrêt, et le problème devient beaucoup plus évident : <a href=https://github.com/percona/percona-server/blob/Percona-Server-8.0.22-13/storage/innobase/srv/srv0start.cc%23L3965#L3965>srv0start.cc:3965</a></p><p>Dans le cadre du processus d&rsquo;arrêt, nous conservons les métadonnées modifiées dans la table DD Buffer ( innodb_dynamic_metadata ), ce qui est faux. Ces modifications seront probablement conservées par le serveur et enregistrées à nouveau une fois que le serveur aura effectué un point de contrôle. En outre, beaucoup de données peuvent être fusionnées selon le moment où la sauvegarde a été effectuée et lorsque le serveur lui-même conserve ces données dans les tables DD. Ceci est le résultat de la mise en œuvre de <a href=https://dev.mysql.com/worklog/task/%3Fid%3D7816>WL#7816</a> et <a href=https://dev.mysql.com/worklog/task/%3Fid%3D6204>WL#6204</a> qui a obligé Percona XtraBackup à modifier la façon dont il gère ces types d&rsquo;enregistrements de rétablissement.</p><p><strong>Résumé</strong></p><p>Dans ce blog, nous avons parcouru le processus d&rsquo;analyse d&rsquo;un véritable bug sur Percona XtraBackup . Ce bug expose un défi auquel nous sommes confrontés dans divers types de bug, où le crash/dysfonctionnement est une conséquence de quelque chose qui s&rsquo;est passé bien avant, et au moment où nous avons une trace de pile/ coredump, il est trop tard pour effectuer une analyse appropriée. L&rsquo;enregistrement et la relecture nous ont permis de rejouer de manière cohérente l&rsquo;exécution du serveur source, ce qui a permis de réduire le problème permettant d’identifier la cause principale.</p><p>Percona XtraBackup est une solution de sauvegarde de base de données complète, gratuite et open source pour toutes les versions de Percona Server pour MySQL</p><ul class=pa0><li class=list><a href=/tags/mysql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MySQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2021</a><div></div></div></footer></body></html>