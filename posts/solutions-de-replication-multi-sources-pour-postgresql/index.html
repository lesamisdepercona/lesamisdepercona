<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Solutions de réplication multi-source pour PostgreSQL | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Traduit à partir de l'article de Ibrar Ahmed intitulé, Multi-Source Replication Solutions for PostgreSQL, disponible sur le blog de Percona"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Solutions de réplication multi-source pour PostgreSQL"><meta property="og:description" content="Traduit à partir de l'article de Ibrar Ahmed intitulé, Multi-Source Replication Solutions for PostgreSQL, disponible sur le blog de Percona"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/solutions-de-replication-multi-sources-pour-postgresql/"><meta property="og:image" content="https://www.lesamisdepercona.fr/posts/article08/image01.png"><meta property="article:published_time" content="2021-07-22T11:43:01+04:00"><meta property="article:modified_time" content="2021-07-22T11:43:01+04:00"><meta itemprop=name content="Solutions de réplication multi-source pour PostgreSQL"><meta itemprop=description content="Traduit à partir de l'article de Ibrar Ahmed intitulé, Multi-Source Replication Solutions for PostgreSQL, disponible sur le blog de Percona"><meta itemprop=datePublished content="2021-07-22T11:43:01+04:00"><meta itemprop=dateModified content="2021-07-22T11:43:01+04:00"><meta itemprop=wordCount content="1892"><meta itemprop=image content="https://www.lesamisdepercona.fr/posts/article08/image01.png"><meta itemprop=keywords content="PostgreSQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/posts/article08/image01.png"><meta name=twitter:title content="Solutions de réplication multi-source pour PostgreSQL"><meta name=twitter:description content="Traduit à partir de l'article de Ibrar Ahmed intitulé, Multi-Source Replication Solutions for PostgreSQL, disponible sur le blog de Percona"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-QZRXTY970R','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-QZRXTY970R','auto');ga('send','pageview');}</script></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/solutions-de-replication-multi-sources-pour-postgresql/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/solutions-de-replication-multi-sources-pour-postgresql/&text=Solutions%20de%20r%c3%a9plication%20multi-source%20pour%20PostgreSQL" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/solutions-de-replication-multi-sources-pour-postgresql/&title=Solutions%20de%20r%c3%a9plication%20multi-source%20pour%20PostgreSQL" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Solutions de réplication multi-source pour PostgreSQL</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-07-22T11:43:01+04:00>July 22, 2021</time>
<span class="f6 mv4 dib tracked">- 9 minutes read</span>
<span class="f6 mv4 dib tracked">- 1892 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p><strong>Solutions de réplication multi-source pour PostgreSQL</strong></p><p>Par <a href=https://www.percona.com/blog/author/ibrar-ahmed/>Ibrar Ahmed</a></p><p>En raison de l&rsquo;immense génération de données, l’évolutivité est devenue l’un des sujets les plus brûlants dans le domaine des bases de données. L’évolutivité peut être réalisée horizontalement ou verticalement. L’évolutivité verticale signifie ajouter plus de ressources/matériel aux nœuds existants pour améliorer la capacité de la base de données à stocker et traiter plus de données, par exemple, ajouter un nouveau processus, mémoire ou disque à un nœud existant. Chaque moteur de SGBD améliore la capacité d’évolutivité verticale en améliorant les mécanismes de verrouillage/mutex et la concurrence par laquelle il peut utiliser plus efficacement les ressources nouvellement ajoutées. Les moteurs de base de données fournissent des paramètres de configuration, ce qui permet d’utiliser plus efficacement les ressources matérielles disponibles.</p><p>En raison du coût du matériel et de la limite d’ajout du nouveau matériel dans le nœud existant, il n’est pas toujours possible d’ajouter du nouveau matériel. Par conséquent, une évolutivité horizontale est requise, ce qui signifie ajouter plus de nœuds aux nœuds de réseau existants au lieu d’améliorer la capacité du nœud existant.</p><p>Contrairement à l’évolutivité verticale, l’évolutivité horizontale est difficile à mettre en œuvre. Il demande plus d’efforts de développement et demande plus de travail de mise en place. PostgreSQL fournit un ensemble de fonctionnalités assez riche pour l’évolutivité verticale et l’évolutivité horizontale. Il prend en charge les machines avec plusieurs processeurs et beaucoup de mémoire et fournit des paramètres de configuration pour gérer l’utilisation de ces ressources. Les nouvelles fonctionnalités de parallélisme de PostgreSQL rendent l’évolutivité verticale plus importante, mais elle ne manque pas non plus d’évolutivité horizontale. La réplication est le pilier crucial de l’évolutivité horizontale, et PostgreSQL prend en charge la réplication source-esclave unidirectionnelle, ce qui est suffisant pour de nombreux cas d’utilisation.</p><p>Concepts clés</p><p><strong>Réplication de base de données</strong></p><p>La réplication de base de données réplique les données sur d’autres serveurs et les stocke sur plusieurs nœuds. Dans ce processus, l’instance de base de données est transférée d’un nœud à un autre et une copie exacte est effectuée. La réplication des données est utilisée pour améliorer la disponibilité des données, une caractéristique clé de la haute disponibilité. Il peut y avoir une instance de base de données complète, ou certains objets fréquemment utilisés ou souhaités sont répliqués sur un autre serveur. Comme la réplication fournit les multiples copies cohérentes de la base de données, elle offre non seulement une haute disponibilité, mais améliore également les performances.</p><p><strong>Réplication synchrone</strong></p><p>Il existe deux stratégies lors de l’écriture des données sur le disque, <strong>synchrone</strong> et <strong>asynchrone.</strong> La réplication synchrone signifie que les données sont écrites simultanément sur le source et l’esclave, en d’autres termes, la « réplication synchrone » signifie que la validation attend l’écriture/le vidage du côté distant. La réplication synchrone est utilisée dans l’environnement transactionnel haut de gamme avec des exigences de basculement instantané.</p><p><strong>Réplication asynchrone</strong></p><p>Asynchrone signifie que les données sont d’abord écrites sur le source, puis répliquées sur l’esclave. En cas de panne, une perte de données peut se produire, mais la réplication asynchrone fournit très peu de surcharge et est donc acceptable dans la plupart des cas. Cela ne surcharge pas le source. Le basculement du primaire au secondaire prend plus de temps qu’avec la réplication synchrone.</p><p>En un mot, la principale différence entre synchrone et asynchrone réside dans le moment où les données sont écrites sur le source et l’esclave.</p><p><strong>Réplication source (Source) unique</strong></p><p>La réplication source unique signifie que les données ne peuvent être modifiées que sur un seul nœud, et ces modifications sont répliquées sur un ou plusieurs nœuds. La mise à jour et l’insertion des données ne sont possibles que sur le nœud source. Dans ce cas, les applications nécessitent d’acheminer le trafic vers la source, ce qui ajoute une certaine complexité à l’application. En raison des sources uniques, il n’y a aucune chance de conflits. La plupart du temps, la réplication à source unique est suffisante pour l’application car elle est moins compliquée à configurer et à gérer. Mais dans certains cas, la réplication à source unique ne suffit pas et vous avez besoin d’une réplication à sources multiples.</p><p><strong>Réplication multisource</strong></p><p>Les réplications multi-sources signifient qu’il y a plus d’un nœud qui fait office de nœuds sources. Les données sont répliquées entre les nœuds et les mises à jour et l’insertion peut être possible sur un groupe de nœuds sources. Dans ce cas, il existe plusieurs copies des données. Le système est également responsable de la résolution de tout conflit survenant entre des modifications simultanées. Il y a deux raisons principales d’avoir une réplication à plusieurs sources : l’un est HA, et le second est la performance. Dans la plupart des cas, certains nœuds sont dédiés à l’opération d’écriture intensive et certains nœuds sont dédiés à certains nœuds ou pour le basculement.</p><p>Voici les avantages et les inconvénients de la réplication multi-sources</p><p><strong>Avantages:</strong></p><ul><li>En cas de défaillance d’une source, l’autre source est là pour effectuer la mise à jour et l’insertion.</li><li>Les nœuds sources sont situés à plusieurs endroits différents, de sorte que les risques de défaillance de toutes les sources sont très minimes.</li><li>Les mises à jour des données sont possibles sur plusieurs serveurs.</li><li>L’application ne nécessite pas de router le trafic vers une seule source.</li></ul><p><strong>Les inconvénients:</strong></p><ul><li>Le principal inconvénient de la réplication multi-sources est sa complexité.</li><li>La résolution des conflits est très difficile car des écritures simultanées sur plusieurs nœuds sont possibles.</li><li>Parfois, une intervention manuelle est nécessaire en cas de conflit.</li><li>Risque d’incohérence des données .</li></ul><p>Comme nous l’avons déjà évoqué, la réplication Single-Source est suffisante dans la plupart des cas et fortement recommandée, mais il existe néanmoins des cas où la réplication Multi-Source est requise. PostgreSQL a une réplication à source unique intégrée, mais malheureusement, il n’y a pas de réplication à sources multiples dans PostgreSQL principal. Certaines solutions de réplication multisource sont disponibles, certaines d’entre elles sont sous forme d’applications et d’autres sont des forks PostgreSQL. Ces forks ont leurs propres petites communautés et sont principalement gérés par une seule entreprise, mais pas par la communauté PostgreSQL principale.</p><p><img src=/posts/article08/image01.png alt="image 01"></p><p>Il existe plusieurs catégories de ces solutions, open-source/closed source, prioritaires, gratuites et payantes.</p><ol><li>BDR (bi- directionnel Replication )</li><li>xDB</li><li>PostgreSQL -XL</li><li>PostgreSQL -XC / PostgreSQL -XC2</li><li>Rubyrep</li><li>Bucardo</li></ol><p>Voici quelques caractéristiques clés de toutes les solutions de réplication</p><p><img src=/posts/article08/image02.png alt="image 02"></p><p>1- BDR (Réplication Bidirectionnelle)</p><p><a href="https://www.2ndquadrant.com/en/resources/postgres-bdr-2ndquadrant/?fbclid=IwAR2BUPuFPFAeZX_G_VrI1zsUc6qCWR-sPCwd1uoCThKJgrUfQUblYXON3m0">BDR</a> est une solution de réplication multi-sources, et il existe différentes versions. Les premières versions de BDR sont open source mais sa dernière version est fermée. Cette solution est <a href=https://www.2ndquadrant.com/en/>développée par 2ndQuadrant</a> et l’une des solutions Multisource les plus élégantes à ce jour. BDR fournit une réplication logique multisource asynchrone. Ceci est basé sur la fonctionnalité de décodage logique de PostgreSQL . Étant donné que BDR applique essentiellement rejoue la transaction sur les autres nœuds, l’opération de relecture peut échouer s’il y a un conflit entre une transaction appliquée et une transaction qui a été validée sur le nœud de réception.</p><p><img src=/posts/article08/image03.png alt="image 03"></p><p>2 – xDB</p><p><a href=https://www.enterprisedb.com/>EnterpriseDB</a> a développé sa propre solution de réplications bidirectionnelles en Java appelée <a href=https://www.enterprisedb.com/edb-docs/d/edb-postgres-replication-server/user-guides/user-guide/6.0/EDB_Postgres_Replication_Server_Users_Guide.1.10.html>xDB</a> . Il est basé sur leur propre protocole. Parce qu’il s’agit d’une solution à source fermée, aucune information de conception n’est connue du monde.</p><ul><li>Développé et maintenu par EnterpriseDB</li><li>Développé en Java.</li><li>Le code source est fermé.</li><li>xDB Replication Server contenait plusieurs programmes exécutables</li><li>Il s’agit d’un logiciel propriétaire entièrement fermé</li><li>Développé en Java, les gens se sont plaints de ses performances</li><li>Le temps de basculement n’est pas acceptable.</li><li>L’interface utilisateur est disponible pour la configuration et la maintenance du système de réplication</li></ul><p><img src=/posts/article08/image04.png alt="image 04"></p><p>3 – PostgreSQL XC/XC2</p><p>PostgreSQL -XC est développé par EnterpriseDB et NTT. C’est une solution de réplication synchrone. Postgres -XC est un projet open source pour fournir une solution de cluster PostgreSQL évolutive en écriture, synchrone, symétrique et transparente. Je n’ai pas vu beaucoup de développement dans PostgreSQL -XC depuis de nombreuses années à partir d’EnterpriseDB et de NTT. Actuellement, Huawei travaille là-dessus. Certains gains de performances ont été signalés dans le cas d’OLAP, mais ne conviennent pas pour TPS.</p><p>4 – PostgreSQL XL</p><p>C’est un fork de PostgreSQL -XC et actuellement pris en charge par 2ndQuadrant. Il est bien derrière Community PostgreSQL. A ce que je sache, il est basé sur PostgreSQL 10.6, qui n’est pas aligné avec PostgreSQL dernière version PostgreSQL-12. Comme nous savons qu’il est basé sur PostgreSQL -XC, il est très bon quand on parle d’OLAP, mais pas très adapté pour Hight TPS.</p><p><img src=/posts/article08/image05.png alt="image 05"></p><p><em>Remarque : Tous les logiciels PostgreSQL XC/XC2/XL sont considérés comme des « logiciels dérivés de PostgreSQL » qui ne sont pas synchronisés avec le développement actuel de PostgreSQL.</em></p><p>5 – Rubyrep</p><p>Il s’agit d’une réplication source-source asynchrone développée par Arndt Lehmann. Il revendique la configuration et l’installation les plus simples et fonctionne sur toutes les plates-formes, y compris Windows. Il fonctionne toujours sur deux serveurs, qui sont référencés comme « gauche » et « droite » dans la terminologie Rubyrep. Il est donc logique de l’appeler une configuration « 2 sources » plutôt que « multi-sources ».</p><ul><li>Le rubyrep peut reproduire en continu les changements entre les bases de données de gauche et de droite.</li><li>Configure automatiquement les déclencheurs nécessaires, les tables de journal, etc.</li><li>Détecte automatiquement les tables nouvellement ajoutées et synchronise le contenu de la table</li><li>Reconfigure automatiquement les séquences pour éviter les conflits de clés en double</li><li>Suit les modifications apportées aux colonnes de clé primaire</li><li>Peut mettre en œuvre à la fois la réplication source-esclave et source-source</li><li>Méthodes de résolution des conflits pré-construites disponibles : victoires gauche/droite ; le changement plus tôt / plus tard gagne</li><li>Résolution de conflit personnalisée spécifiable via des extraits de code ruby</li><li>Les décisions de réplication peuvent éventuellement être enregistrées dans la table du journal des événements rubyrep</li></ul><p><em>Remarque : – Ce projet n’a pas été actif depuis trois ans, en termes de développement.</em></p><p>6 – Bucardo</p><p><a href=https://github.com/bucardo/bucardo>Bucardo</a> est une solution de réplication basée sur Trigger développée par Jon Jensen et Greg Sabino Mullane de <a href=https://www.endpoint.com/>End Point Corporation</a> . La solution de Bucardo existe depuis près de 20 ans maintenant et a été conçue à l’origine comme une solution asynchrone «paresseuse» qui <em>finit par</em> répliquer toutes les modifications. Il existe un Perl daemon qui écoute les requêtes NOTIFY et agit sur celles-ci. Les changements qui se produisent sur les tables sont enregistrés dans une table ( bucardo_delta ) et notifie le daemon. Daemon avertit le contrôleur qui lance un «kid» pour synchroniser les changements de table. En cas de conflit, des gestionnaires de conflit standard ou personnalisés sont utilisés pour le résoudre.</p><ul><li>Réplication basée sur des déclencheurs</li><li>Politique de résolution des conflits</li><li>Dépendance sur Perl 5, DBI, DBD::Pg, DBIx ::Safe.</li><li>L’installation et la configuration sont complexes.</li><li>La réplication s’interrompt souvent et est boguée.</li></ul><p><strong>Conclusion</strong></p><p>La plupart des cas de réplication à source unique suffisent, et il a été observé que les gens configurent la réplication multi-source et compliquent excessivement leur conception. Il est fortement recommandé de concevoir le système et d’essayer d’éviter la réplication multi-source et de ne l’utiliser que là où il n’y a aucun moyen de concevoir le système sans cela. Il y a deux raisons : la première est que cela rend le système trop complexe et difficile à déboguer, et deuxièmement, vous n’obtiendrez aucun support de la communauté PostgreSQL car il n’y a pas de réplications multi-sources gérées par la communauté.</p><p>Source : <a href=https://www.percona.com/blog/2020/06/09/multi-master-replication-solutions-for-postgresql/>Blog Percona</a></p><ul class=pa0><li class=list><a href=/tags/postgresql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">PostgreSQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2021</a><div></div></div></footer></body></html>