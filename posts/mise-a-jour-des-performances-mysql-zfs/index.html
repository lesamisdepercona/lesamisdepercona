<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Mise à jour des performances MySQL/ZFS | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Les avantages de l'utilisation de ZFS par rapport à ext4 en termes de performances"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Mise à jour des performances MySQL/ZFS"><meta property="og:description" content="Les avantages de l'utilisation de ZFS par rapport à ext4 en termes de performances"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/mise-a-jour-des-performances-mysql-zfs/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail/thumbnailarticle17.jpg"><meta property="article:published_time" content="2021-09-24T11:43:01+04:00"><meta property="article:modified_time" content="2021-09-24T11:43:01+04:00"><meta itemprop=name content="Mise à jour des performances MySQL/ZFS"><meta itemprop=description content="Les avantages de l'utilisation de ZFS par rapport à ext4 en termes de performances"><meta itemprop=datePublished content="2021-09-24T11:43:01+04:00"><meta itemprop=dateModified content="2021-09-24T11:43:01+04:00"><meta itemprop=wordCount content="1305"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail/thumbnailarticle17.jpg"><meta itemprop=keywords content="MySQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail/thumbnailarticle17.jpg"><meta name=twitter:title content="Mise à jour des performances MySQL/ZFS"><meta name=twitter:description content="Les avantages de l'utilisation de ZFS par rapport à ext4 en termes de performances"><script async src="https://www.googletagmanager.com/gtag/js?id=G-W9SYN1YL24"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-W9SYN1YL24');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-203534013-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-203534013-1');</script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/mise-a-jour-des-performances-mysql-zfs/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/mise-a-jour-des-performances-mysql-zfs/&text=Mise%20%c3%a0%20jour%20des%20performances%20MySQL/ZFS" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/mise-a-jour-des-performances-mysql-zfs/&title=Mise%20%c3%a0%20jour%20des%20performances%20MySQL/ZFS" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Mise à jour des performances MySQL/ZFS</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-09-24T11:43:01+04:00>September 24, 2021</time>
<span class="f6 mv4 dib tracked">- 7 minutes read</span>
<span class="f6 mv4 dib tracked">- 1305 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p>Comme certains d&rsquo;entre vous le savent probablement, j&rsquo;ai une opinion favorable de ZFS et en particulier de MySQL sur ZFS. Comme je l&rsquo;ai <a href=https://www.percona.com/blog/2018/05/15/about-zfs-performance/>publié</a> il y a quelques années, l&rsquo;argument en faveur de ZFS concernait moins les performances que ses fonctionnalités utiles telles que la compression de données et les instantanés. À l&rsquo;époque, ZFS était significativement plus lent que xfs et ext4, sauf lorsque le L2ARC était utilisé.</p><p>Depuis lors, cependant, ZFS sur Linux a beaucoup progressé et j&rsquo;ai également appris à mieux le régler. De plus, j&rsquo;ai découvert que le benchmark sysbench que j&rsquo;utilisais à l&rsquo;époque n&rsquo;était pas un choix juste car l&rsquo;ensemble de données qu&rsquo;il génère se compresse beaucoup moins qu&rsquo;un fichier réaliste. Pour toutes ces raisons, je pense qu&rsquo;il est temps de revisiter l&rsquo;aspect performance de MySQL sur ZFS.</p><p><strong>Évolution de ZFS</strong></p><p>En 2018, j&rsquo;ai rapporté les résultats de performances ZFS basés sur la version 0.6.5.6, la version par défaut disponible dans Ubuntu Xenial. Le présent article utilise la version 0.8.6-1 de ZFS, la version par défaut disponible sur Debian Buster. Entre les deux versions, il y a plus de 3600 commits en ajoutant un certain nombre de nouvelles fonctionnalités comme le support des opérations <em>trim</em> et l&rsquo;ajout de algorithme de compression <em>zstd</em>.</p><p>ZFS 0.8.6-1 n&rsquo;est pas à la pointe, il y a eu plus de 1700 commits depuis et après la 0.8.6, le numéro de version de ZFS est passé à 2.0. Le gros ajout inclus dans la version 2.0 est le cryptage natif.</p><p><strong>Outils de référence</strong></p><p>Les benchmarks classiques de la base de données MySQL sysbench ont un ensemble de données contenant principalement des données aléatoires. De tels ensembles de données ne compressent pas beaucoup, moins que la plupart des ensembles de données du monde réel avec lesquels j&rsquo;ai travaillé. La compressibilité de l&rsquo;ensemble de données est importante car les caches ZFS, l&rsquo;ARC et L2ARC, stockent les données compressées. Un meilleur taux de compression signifie essentiellement que plus de données sont mises en cache et moins d&rsquo;opérations IO seront nécessaires.</p><p>Un outil bien connu pour comparer le volume de travail transactionnel est TPCC. De plus, l&rsquo;ensemble de données créé par TPCC se compresse assez bien, ce qui le rend plus réaliste dans le contexte de cet article. Nous utilisons l’<a href=https://github.com/Percona-Lab/sysbench-tpcc>implémentation sysbench TPCC</a></p><p><strong>Environnement Test</strong></p><p>Comme je connais déjà AWS et Google cloud, j&rsquo;ai décidé d&rsquo;essayer Azure pour ce projet. J&rsquo;ai lancé ces deux machines virtuelles :</p><p>tpcc :</p><ul><li>hôte de référence</li><li>Instance D2ds_v4 standard</li><li>2 vCpu , 8 Go de RAM et 75 Go de stockage temporaire</li><li>Debian Buster</li></ul><p>db :</p><ul><li>Hôte de la base de données</li><li>Instance E4-2ds-v4 standard</li><li>2 vCpu , 32 Go de RAM et 150 Go de stockage temporaire</li><li>256 Go SSD Premium (SSD Premium LRS P15 – 1100 IOPS (3500 burst), 125 Mo/s)</li><li>Debian Buster</li><li>Percona serveur 8.0.22-13</li></ul><p><strong>Configuration</strong></p><p>Par défaut et sauf indication contraire, les systèmes de fichiers ZFS sont créés avec :</p><pre><code>zpool create bench /dev/sdc
zfs set compression=lz4 atime=off logbias=throughput bench
zfs create -o mountpoint=/var/lib/mysql/data -o recordsize=16k \
           -o primarycache=metadata bench/data
zfs create -o mountpoint=/var/lib/mysql/log bench/log
</code></pre><p>Il existe deux systèmes de fichiers ZFS. <em>bench/data</em> est optimisé pour l&rsquo;ensemble de données InnoDB tandis que <em>bench/log</em> est réglé pour les fichiers journaux InnoDB . Les deux sont compressés à l&rsquo;aide de lz4 et le paramètre <em>logbias</em> est défini sur le <em>débit,</em> ce qui modifie la façon dont le ZIL est utilisé. Avec ext4, l&rsquo;option <em>noatime</em> est utilisée.</p><p>ZFS a également un certain nombre de paramètres de noyau, ceux définis sur des valeurs autres que celles par défaut sont :</p><pre><code>zfs_arc_max=2147483648
zfs_async_block_max_blocks=5000
zfs_delete_blocks=1000
</code></pre><p>Essentiellement, les paramètres ci-dessus limitent la taille de l&rsquo;ARC à 2 Go et réduisent l&rsquo;agressivité de ZFS pour les suppressions. Enfin, la configuration de la base de données est légèrement différente entre ZFS et ext4. Il y a une section commune :</p><pre><code>[mysqld]
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
log-error = /var/log/mysql/error.log
skip-log-bin
datadir = /var/lib/mysql/data
innodb_buffer_pool_size = 26G
innodb_flush_log_at_trx_commit = 1 # TPCC reqs.
innodb_log_file_size = 1G
innodb_log_group_home_dir = /var/lib/mysql/log
innodb_flush_neighbors = 0
innodb_fast_shutdown = 2
</code></pre><p>et lorsque ZFS est utilisé :</p><pre><code>innodb_flush_method = O_DIRECT
</code></pre><p>et lorsque ZFS est utilisé :</p><pre><code>innodb_flush_method = fsync
innodb_doublewrite = 0 # ZFS is transactional
innodb_use_native_aio = 0
innodb_read_io_threads = 10
innodb_write_io_threads = 10
</code></pre><p>ZFS ne prend pas en charge <em>O_DIRECT</em> mais il est ignoré avec un message dans le journal des erreurs. J&rsquo;ai choisi de définir explicitement la méthode flush sur <em>fsync</em>. Le tampon à double écriture n&rsquo;est pas nécessaire avec ZFS et j&rsquo;avais l&rsquo;impression que l&rsquo;implémentation IO asynchrones natives de Linux n&rsquo;était pas bien prise en charge par ZFS. Je l&rsquo;ai donc désactivée et augmenté le nombre de threads d&rsquo;IO. Nous reviendrons sur la question des IO asynchrones dans un prochain article.</p><p><strong>Base de données</strong></p><p>J&rsquo;utilise la commande suivante pour créer l&rsquo;ensemble de données :</p><pre><code>./tpcc.lua --mysql-host=10.3.0.6 --mysql-user=tpcc --mysql-password=tpcc --mysql-db=tpcc \
--threads=8 --tables=10 --scale=200 --db-driver=mysql prepare
</code></pre><p>L&rsquo;ensemble de données résultant a une taille d&rsquo;environ 200 Go. L&rsquo;ensemble de données est beaucoup plus volumineux que le pool de mémoire tampon, de sorte que les performances de la base de données sont essentiellement liées aux IO.</p><p><strong>Procédure Test</strong></p><p>L&rsquo;exécution de chaque benchmark a été scriptée et a suivi ces étapes :</p><ol><li>Arrêter MySQL</li><li>Supprimer tous les fichiers de données</li><li>Ajuster le système de fichiers</li><li>Copier l&rsquo;ensemble de données</li><li>Ajuster la configuration MySQL</li><li>Démarrer MySQL</li><li>Enregistrer la configuration</li><li>Exécuter le benchmark</li></ol><p><strong>Résultats</strong></p><p>Pour le benchmark, j&rsquo;ai utilisé l&rsquo;invocation suivante :</p><pre><code>./tpcc.lua --mysql-host=10.3.0.6 --mysql-user=tpcc --mysql-password=tpcc --mysql-db=tpcc \
--threads=16 --time=7200 --report-interval=10 --tables=10 --scale=200 --db-driver=mysql ru
</code></pre><p>Le benchmark TPCC utilise 16 threads pour une durée de 2 heures. La durée est suffisamment longue pour permettre un état stationnaire et épuiser la capacité de stockage. Sysbench renvoie le nombre total de transactions TPCC par seconde toutes les 10 s. Ce nombre comprend non seulement les transactions de <em>nouvelle commande</em>, mais également les autres types de transactions comme le <em>paiement</em>, le <em>statut de la commande</em>, etc. Sachez-le si vous souhaitez comparer ces résultats avec d&rsquo;autres références TPCC.</p><p>Dans ces conditions, la figure ci-dessous présente les taux de transactions TPCC au fil du temps pour ext4 et ZFS.</p><p><img src=/posts/article17/img01.png alt=image01></p><p><em>Résultats MySQL TPCC pour ext4 et ZFS</em></p><p>Au cours des 15 premières minutes, le pool de mémoire tampon se réchauffe, mais à un moment donné, la charge de travail se déplace entre une lecture IO liée à une écriture IO et à un processeur. Ensuite, à environ 3000 s, la capacité de SSD Premium est épuisée et la charge de travail n&rsquo;est liée qu&rsquo;aux IO. J&rsquo;ai été un peu surpris par les résultats, assez pour refaire les benchmarks pour m&rsquo;en assurer. Les résultats pour ext4 et ZFS <strong>sont qualitativement similaires.</strong> Toute différence est dans la marge d&rsquo;erreur. Cela signifie essentiellement que si vous configurez correctement ZFS, il peut être aussi efficace en IO que ext4.</p><p>Ce qui est intéressant, c&rsquo;est la quantité de stockage utilisée. Alors que l&rsquo;ensemble de données sur ext4 consommait 191 Go, la compression lz4 de ZFS a donné un ensemble de données de seulement 69 Go. C&rsquo;est une énorme différence, un facteur de 2,8, qui pourrait économiser une somme d&rsquo;argent décente au fil du temps pour les grands ensembles de données.</p><p><strong>Conclusion</strong></p><p>Il semble que c&rsquo;était effectivement le bon moment pour revisiter les performances de MySQL avec ZFS. Dans un cas d&rsquo;utilisation assez réaliste, ZFS est comparable à ext4 en termes de performances tout en offrant les avantages supplémentaires de la compression de données, des instantanés, etc. Dans le prochain article, j&rsquo;examine l&rsquo;utilisation du <a href=https://www.percona.com/blog/mysql-zfs-in-the-cloud-leveraging-ephemeral-storage/>stockage éphémère dans le cloud avec ZFS</a> et je vois comment cela pourrait améliorer les performances.  </p><p><strong>Percona Distribution pour MySQL est la solution MySQL open source la plus complète, stable, évolutive et sécurisée disponible, offrant des environnements de base de données de niveau entreprise pour vos applications métier les plus critiques… et son utilisation est gratuite !</strong></p><p><a href=https://www.percona.com/software/mysql-database>Télécharger Percona Distribution pour MySQL</a></p><p>Source : <a href=https://www.percona.com/blog/mysql-zfs-performance-update/>Blog Percona</a></p><ul class=pa0><li class=list><a href=/tags/mysql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MySQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2022</a><div></div></div></footer></body></html>