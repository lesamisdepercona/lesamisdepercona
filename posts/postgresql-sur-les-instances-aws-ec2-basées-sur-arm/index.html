<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>PostgreSQL sur les instances AWS EC2 basées sur ARM c'est bien | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="un regard indépendant sur le rapport prix/performances des nouvelles instances du point de vue de l'exécution de PostgreSQL"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="PostgreSQL sur les instances AWS EC2 basées sur ARM c'est bien"><meta property="og:description" content="un regard indépendant sur le rapport prix/performances des nouvelles instances du point de vue de l'exécution de PostgreSQL"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/postgresql-sur-les-instances-aws-ec2-bas%C3%A9es-sur-arm/"><meta property="article:published_time" content="2021-07-04T11:43:01+04:00"><meta property="article:modified_time" content="2021-07-04T11:43:01+04:00"><meta itemprop=name content="PostgreSQL sur les instances AWS EC2 basées sur ARM c'est bien"><meta itemprop=description content="un regard indépendant sur le rapport prix/performances des nouvelles instances du point de vue de l'exécution de PostgreSQL"><meta itemprop=datePublished content="2021-07-04T11:43:01+04:00"><meta itemprop=dateModified content="2021-07-04T11:43:01+04:00"><meta itemprop=wordCount content="1710"><meta itemprop=keywords content="PostgreSQL,"><meta name=twitter:card content="summary"><meta name=twitter:title content="PostgreSQL sur les instances AWS EC2 basées sur ARM c'est bien"><meta name=twitter:description content="un regard indépendant sur le rapport prix/performances des nouvelles instances du point de vue de l'exécution de PostgreSQL"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/postgresql-sur-les-instances-aws-ec2-bas%C3%A9es-sur-arm/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/postgresql-sur-les-instances-aws-ec2-bas%C3%A9es-sur-arm/&text=PostgreSQL%20sur%20les%20instances%20AWS%20EC2%20bas%c3%a9es%20sur%20ARM%20c%27est%20bien" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/postgresql-sur-les-instances-aws-ec2-bas%C3%A9es-sur-arm/&title=PostgreSQL%20sur%20les%20instances%20AWS%20EC2%20bas%c3%a9es%20sur%20ARM%20c%27est%20bien" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">PostgreSQL sur les instances AWS EC2 basées sur ARM c'est bien</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-07-04T11:43:01+04:00>July 4, 2021</time>
<span class="f6 mv4 dib tracked">- 9 minutes read</span>
<span class="f6 mv4 dib tracked">- 1710 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p>La croissance attendue des processeurs ARM dans les centres de données est au centre de sujet de discussion depuis un certain temps, et nous étions curieux de voir comment cela fonctionnait avec PostgreSQL. La disponibilité générale des serveurs basés sur ARM pour les tests et l'évaluation était un obstacle majeur. Le brise-glace a eu lieu lorsqu'AWS a <a href=https://aws.amazon.com/about-aws/whats-new/2018/11/introducing-amazon-ec2-a1-instances/>annoncé son offre de processeurs basés sur ARM</a> dans son cloud en 2018. Mais nous n'avons pas pu voir beaucoup d'enthousiasme dans l'immédiat, car beaucoup considéraient qu'il s'agissait de choses plus «expérimentales». Nous étions également prudents quant à sa recommandation pour une utilisation critique et n'avons jamais fait assez d'efforts pour l'évaluer. Mais lorsque la deuxième génération d'<a href=https://aws.amazon.com/blogs/aws/new-m6g-ec2-instances-powered-by-arm-based-aws-graviton2/>instances basées sur Graviton2 a été annoncée en mai 2020</a>, nous l'avions considéré davantage. Nous avons décidé de jeter un regard indépendant sur le rapport prix/performances des nouvelles instances du point de vue de l'exécution de PostgreSQL.</p><p><strong>Important</strong> : Notez que même s'il est tentant d'appeler cette comparaison de PostgreSQL sur x86 vs arm, ce ne serait pas correct. Ces tests comparent PostgreSQL sur deux instances de cloud virtuel, et cela inclut bien plus de pièces mobiles qu'un simple processeur. Nous nous concentrons principalement sur le rapport qualité-prix de deux instances AWS EC2 particulières basées sur deux architectures différentes.</p><h2 id=test-configuration>Test Configuration</h2><p>Pour ce test, nous avons sélectionné deux instances similaires. L'un est l'ancien m5d . 8xlarge , et l'autre est le nouveau Graviton2 basé m6gd.8xlarge . Les deux instances sont livrées avec un stockage « éphémère » local que nous utiliserons ici. L'utilisation de disques locaux très rapides devrait permettre d'exposer les différences dans d'autres parties du système et d'éviter de tester le stockage en nuage. Les instances ne sont pas parfaitement identiques, comme vous le verrez ci-dessous, mais sont suffisamment proches pour être considérées comme de même niveau. Nous avons utilisé Ubuntu 20.04 AMI et PostgreSQL 13.1 du pgdg repo. Nous avons effectué des tests avec des bases de données de tailles petites (in-memory) et large (io-bound).</p><h3 id=instances>Instances</h3><p>Spécifications et tarification à la demande des instances selon les <a href=https://aws.amazon.com/ec2/pricing/on-demand/>informations de tarification AWS</a> pour Linux dans la région de Virginie du Nord. Avec les prix actuellement affichés, m6gd.8xlarge est 25% moins cher.</p><h5 id=instance-graviton2-arm>Instance Graviton2 (ARM)</h5><pre><code>Instance : m6gd.8xlarge 	
Virtual CPUs : 32
RAM  : 128 GiB 	
Storage : 1 x 1900 NVMe SSD (1.9 TiB)
Price : $1.4464 per Hour
</code></pre><h5 id=instance-régulière-x86>Instance Régulière (x86)</h5><pre><code>Instance : m5d.8xlarge
Virtual CPUs : 32
RAM : 128 GiB
Storage : 2 x 600 NVMe SSD (1.2 TiB)
Price : $1.808 per Hour
</code></pre><h3 id=configuration-du-système-d39exploitation-os-et-de-postgresql>Configuration du système d'exploitation (OS) et de PostgreSQL</h3><p>Nous avons sélectionné les AMI Ubuntu 20.04.1 LTS pour les instances et n'avons rien changé du côté du système d'exploitation. Sur l'instance m5d.8xlarge, deux disques NVMe locaux ont été unifiés dans un seul périphérique raid0. PostgreSQL a été installé à l'aide de .deb disponibles dans le repository PGDG.</p><p>La chaîne de version de PostgreSQL confirme l'architecture du système d'exploitation</p><pre><code>postgres=# select version();
                                                                version                                                                 
----------------------------------------------------------------------------------------------------------------------------------------
 PostgreSQL 13.1 (Ubuntu 13.1-1.pgdg20.04+1) on aarch64-unknown-linux-gnu, compiled by gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0, 64-bit
(1 row)
</code></pre><p>** aarch64 signifie architecture ARM 64 bits</p><p>La configuration PostgreSQL suivante a été utilisée pour les tests.</p><pre><code>max_connections = '200'
shared_buffers = '32GB'
checkpoint_timeout = '1h'
max_wal_size = '96GB'
checkpoint_completion_target = '0.9'
archive_mode = 'on'
archive_command = '/bin/true'
random_page_cost = '1.0'
effective_cache_size = '80GB'
maintenance_work_mem = '2GB'
autovacuum_vacuum_scale_factor = '0.4'
bgwriter_lru_maxpages = '1000'
bgwriter_lru_multiplier = '10.0'
wal_compression = 'ON'
log_checkpoints = 'ON'
log_autovacuum_min_duration = '0'
</code></pre><h2 id=tests-pgbench>Tests pgbench</h2><p>Tout d'abord, une première série de tests est effectuée à l'aide de pgbench, l'outil de micro-benchmarking disponible avec PostgreSQL. Cela nous permet de tester avec une combinaison différente d'un certain nombre de clients et d'emplois comme :</p><pre><code>pgbench -c 16 -j 16 -T 600 -r
</code></pre><p>Où 16 connexions client et 16 tâches pgbench alimentant les connexions client sont utilisées.</p><h3 id=lecture-écriture-sans-somme-de-contrôle-checksum>Lecture-écriture sans somme de contrôle (Checksum)</h3><p>La charge par défaut créée par pgbench est une charge en lecture-écriture de type tpcb. Nous avons utilisé la même chose sur une instance PostgreSQL sur laquelle la somme de contrôle n'est pas activée.</p><p>Nous pourrions voir un gain de performance de <strong>19%</strong> sur ARM.</p><table><thead><tr><th>x86 (tps)</th><th>28878</th></tr></thead><tbody><tr><td>ARM (tps)</td><td>34409</td></tr></tbody></table><p><img src=/posts/article05/p05_image01.png alt="image 01"></p><h3 id=lecture--écriture-avec-somme-de-contrôle-checksum>Lecture- écriture avec somme de contrôle (Checksum)</h3><p>Nous étions curieux de savoir si le calcul de la somme de contrôle avait un impact sur les performances en raison de la différence d'architecture si la somme de contrôle de niveau PostgreSQL est activée. Sur PostgreSQL 12 et les versions ultérieures, la somme de contrôle peut être activée à l'aide de l'utilitaire pg_checksum comme suit :</p><pre><code>pg_checksums -e -D $PGDATA
</code></pre><table><thead><tr><th>x86 (tps)</th><th>29402</th></tr></thead><tbody><tr><td>ARM (tps)</td><td>34701</td></tr></tbody></table><p><img src=/posts/article05/p05_image02.png alt="image 02"></p><p>À notre grande surprise, les résultats étaient légèrement meilleurs! Comme la différence n'est que de 1,7%, nous considérons cela comme un bruit. Au moins, nous pensons qu'il est acceptable de conclure que l'activation de la somme de contrôle n'entraîne aucune dégradation notable des performances sur ces processeurs modernes.</p><h3 id=lecture-seule-sans-somme-de-contrôle-checksum>Lecture seule sans somme de contrôle (Checksum)</h3><p>Les charges en lecture seule devraient être centrées sur le processeur. Étant donné que nous avons sélectionné une taille de base de données qui s'intègre parfaitement dans la mémoire, nous pourrions éliminer les frais généraux liés aux E/S.</p><table><thead><tr><th>x86 (tps)</th><th>221436.05</th></tr></thead><tbody><tr><td>ARM (tps)</td><td>288867.44</td></tr></tbody></table><p><img src=/posts/article05/p05_image03.png alt="image 03"></p><p>Les résultats ont montré un gain de <strong>30%</strong> en tps pour l'ARM par rapport à l'instance x86 .</p><h3 id=lecture-seule-avec-somme-de-contrôle-checksum>Lecture seule avec somme de contrôle (Checksum)</h3><p>Nous voulions vérifier si nous pouvions observer un changement de tps si la somme de contrôle était activée lorsque la charge devient purement centrée sur le processeur.</p><table><thead><tr><th>x86 (tps)</th><th>221144.3858</th></tr></thead><tbody><tr><td>ARM (tps)</td><td>279753.1082</td></tr></tbody></table><p><img src=/posts/article05/p05_image04.png alt="image 04"></p><p>Les résultats sont très proches du précédent, avec des gains de 26,5%.</p><p>Dans les tests de pgbench, nous avons observé que lorsque la charge devient centrée sur le processeur, la différence de performances augmente. Nous n'avons pu observer aucune dégradation des performances avec la somme de contrôle.</p><h3 id=_remarque-sur-les-sommes-de-contrôle_><em>Remarque sur les sommes de contrôle</em></h3><p><em>PostgreSQL calcule et écrit la somme de contrôle des pages lorsqu'elles sont écrites et lues dans le pool de mémoire tampon. De plus, les bits d'indication sont toujours enregistrés lorsque les sommes de contrôle sont activées, ce qui augmente la pression WAL IO. Pour valider correctement la surcharge globale de la somme de contrôle, nous aurions besoin de tests plus longs et plus importants, comme nous l'avons fait avec sysbench-tpcc .</em></p><h2 id=test-avec-sysbench-tpcc>Test avec sysbench-tpcc</h2><p>Nous avons décidé d'effectuer des tests plus détaillés en utilisant <a href=https://github.com/Percona-Lab/sysbench-tpcc>sysbench-tpcc</a> . Nous nous sommes principalement intéressés au cas où la base de données s'insère dans la mémoire. En passant, alors que PostgreSQL sur le serveur arm n'a montré aucun problème, sysbench était beaucoup plus capricieux que celui de x86.</p><p>Chaque série de tests comportait quelques étapes :</p><ol><li>Restaurer le répertoire de données de la balance nécessaire (10/200).</li><li>Exécutez un test de préchauffage de 10 minutes avec les mêmes paramètres que le test de grande envergure.</li><li>Point de contrôle côté PG.</li><li>Exécutez le test réel.</li></ol><h3 id=en-mémoire-16-threads->En mémoire, 16 threads :</h3><p><img src=/posts/article05/p05_image05.png alt="image 05"></p><p>Avec cette charge modérée, l'instance ARM affiche des performances environ <strong>15,5%</strong> meilleures que l'instance x86. Ici et après, la différence en pourcentage est basée sur la valeur moyenne du tps.</p><p>Vous vous demandez peut-être pourquoi il y a une baisse soudaine des performances vers la fin du test. Il est lié au point de contrôle avec full_page_writes . Même si pour les tests en mémoire, nous avons utilisé la distribution pareto, une quantité considérable de pages va être écrite après chaque point de contrôle. Dans ce cas, l'instance affichant plus de performances a déclenché un point de contrôle par WAL plus tôt que son homologue. Ces creux seront présents dans tous les tests effectués.</p><h3 id=en-mémoire--32-threads->En mémoire , 32 threads :</h3><p><img src=/posts/article05/p05_image06.png alt="image 06"></p><p>Lorsque la simultanéité est passée à 32, la différence de performances a été réduite à près de <strong>8 %</strong>.</p><h3 id=en-mémoire-64-threads->En mémoire, 64 threads :</h3><p><img src=/posts/article05/p05_image07.png alt="image 07"></p><p>En poussant les instances près de leur point de saturation (rappelez-vous, les deux sont des instances à 32 processeurs), nous voyons la différence se réduire encore à <strong>4,5%</strong>.</p><h3 id=en-mémoire--128-threads->En mémoire , 128 threads :</h3><p><img src=/posts/article05/p05_image08.png alt="image 08"></p><p>Lorsque les deux instances ont dépassé leur point de saturation, la différence de performances devient négligeable, bien qu'elle soit toujours là à <strong>1,4%.</strong> De plus, nous avons pu observer une baisse de <strong>6 à 7%</strong> du débit ( tps ) pour ARM et une baisse de <strong>4%</strong> pour x86 en cas de concurrence augmenté de 64 à 128 sur ces 32 machines vCPU.</p><p>Tout ce que nous avons mesuré n'est pas favorable à l'instance basée sur Graviton2. Dans les tests liés aux E/S (ensemble de données ~ 200G, 200 entrepôts, distribution uniforme), nous avons vu moins de différence entre les deux instances, et à 64 et 128 threads, l'instance m5d standard a mieux fonctionné. Vous pouvez le voir sur les graphiques combinés ci-dessous.</p><p><img src=/posts/article05/p05_image09.png alt="image 09"></p><p>Une raison possible à cela, en particulier l'effondrement important à 128 threads pour m6gd.8xlarge, est qu'il lui manque le deuxième lecteur que m5d.8xlarge possède. Il n'y a actuellement aucun couple d'instances parfaitement comparables disponibles, nous considérons donc cela comme une comparaison équitable; chaque type d'instance a un avantage. Davantage de tests et de profils sont nécessaires pour identifier correctement la cause, car nous nous attendions à ce que les disques locaux affectent de manière négligeable les tests. Des tests liés aux E/S avec EBS peuvent potentiellement être effectués pour essayer de supprimer les disques locaux de l'équation.</p><p>Plus de détails sur la configuration de test, les résultats des tests, des scripts utilisés, et les données générées au cours de l'essai sont disponibles sur <a href=https://github.com/arronax/scratch/tree/master/performance/graviton2-postgres>ce</a><a href=https://github.com/arronax/scratch/tree/master/performance/graviton2-postgres>GitHub</a><a href=https://github.com/arronax/scratch/tree/master/performance/graviton2-postgres>repo</a> .</p><h3 id=résumé>Résumé</h3><p>Il n'y a pas eu beaucoup de cas où l'instance ARM est devenue plus lente que l' instance x86 dans les tests que nous avons effectués. Les résultats des tests étaient cohérents tout au long des tests des deux derniers jours. Alors que l'instance basée sur ARM est 25 % moins chère, elle est capable d'afficher un gain de performances de 15 à 20 % dans la plupart des tests par rapport aux instances x86 correspondantes. Ainsi, les instances basées sur ARM offrent un rapport qualité-prix nettement meilleur à tous égards. Nous devrions nous attendre à ce que de plus en plus de fournisseurs de cloud fournissent des instances basées sur ARM à l'avenir. S'il vous plaît laissez-nous savoir si vous souhaitez voir un autre type de tests de référence.</p><p>Source : <a href=https://www.percona.com/blog/2021/01/22/postgresql-on-arm-based-aws-ec2-instances-is-it-any-good/>Percona</a></p><ul class=pa0><li class=list><a href=/tags/postgresql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">PostgreSQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2021</a><div></div></div></footer></body></html>