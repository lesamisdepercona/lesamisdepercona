<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Migrer une base de données PostgreSQL vers Kubernetes | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Migration des bases de données pour les entreprises. Cas d'une base de données PostgreSQL vers Kubernetes avec Percona Distribution for PostgreSQL Operator"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Migrer une base de données PostgreSQL vers Kubernetes"><meta property="og:description" content="Migration des bases de données pour les entreprises. Cas d'une base de données PostgreSQL vers Kubernetes avec Percona Distribution for PostgreSQL Operator"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/migration-des-bases-de-donn%C3%A9es-postgresql-vers-kubernetes/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail/thumbnailarticle22.jpg"><meta property="article:published_time" content="2021-11-01T11:43:01+04:00"><meta property="article:modified_time" content="2021-11-01T11:43:01+04:00"><meta itemprop=name content="Migrer une base de données PostgreSQL vers Kubernetes"><meta itemprop=description content="Migration des bases de données pour les entreprises. Cas d'une base de données PostgreSQL vers Kubernetes avec Percona Distribution for PostgreSQL Operator"><meta itemprop=datePublished content="2021-11-01T11:43:01+04:00"><meta itemprop=dateModified content="2021-11-01T11:43:01+04:00"><meta itemprop=wordCount content="1405"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail/thumbnailarticle22.jpg"><meta itemprop=keywords content="PostgreSQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail/thumbnailarticle22.jpg"><meta name=twitter:title content="Migrer une base de données PostgreSQL vers Kubernetes"><meta name=twitter:description content="Migration des bases de données pour les entreprises. Cas d'une base de données PostgreSQL vers Kubernetes avec Percona Distribution for PostgreSQL Operator"><script async src="https://www.googletagmanager.com/gtag/js?id=G-W9SYN1YL24"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-W9SYN1YL24');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-203534013-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-203534013-1');</script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/migration-des-bases-de-donn%C3%A9es-postgresql-vers-kubernetes/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/migration-des-bases-de-donn%C3%A9es-postgresql-vers-kubernetes/&text=Migrer%20une%20base%20de%20donn%c3%a9es%20PostgreSQL%20vers%20Kubernetes" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/migration-des-bases-de-donn%C3%A9es-postgresql-vers-kubernetes/&title=Migrer%20une%20base%20de%20donn%c3%a9es%20PostgreSQL%20vers%20Kubernetes" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Migrer une base de données PostgreSQL vers Kubernetes</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-11-01T11:43:01+04:00>November 1, 2021</time>
<span class="f6 mv4 dib tracked">- 7 minutes read</span>
<span class="f6 mv4 dib tracked">- 1405 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p>De plus en plus d&rsquo;entreprises adoptent Kubernetes. Pour certains, il s&rsquo;agit d&rsquo;être à la pointe de la technologie, pour d’autres, il s&rsquo;agit d&rsquo;une stratégie bien définie et d&rsquo;une transformation de l&rsquo;entreprise. Les développeurs et les équipes d&rsquo;exploitation du monde entier ont du mal à déplacer des applications qui ne sont pas compatibles avec le cloud natif pour les conteneurs et Kubernetes.</p><p>La migration des bases de données est toujours un défi, qui comporte des risques et des temps d&rsquo;arrêt pour les entreprises. Aujourd&rsquo;hui, je vais montrer à quel point il est facile de migrer une base de données PostgreSQL vers Kubernetes avec un temps d&rsquo;arrêt minimal avec <a href=https://www.percona.com/doc/kubernetes-operator-for-postgresql/index.html>Percona Distribution for PostgreSQL Operator</a> . </p><h2 id=objectif>Objectif</h2><p>Pour effectuer la migration, je vais utiliser la configuration suivante :</p><p><img src=/posts/article22/img01.png alt=image01></p><ol><li>Base de données PostgreSQL déployée sur site ou quelque part dans le cloud. Ce sera la Source.</li><li><a href=https://cloud.google.com/kubernetes-engine>Cluster Google Kubernetes Engine</a> (GKE) où Percona Operator déploie et gère le cluster PostgreSQL (la cible) et le pod <a href=https://pgbackrest.org/>pgBackRest</a>   </li><li>Les sauvegardes PostgreSQL et les journaux d&rsquo;écriture anticipée sont téléchargés dans un compartiment de stockage d&rsquo;objets (GCS dans mon cas)</li><li>Pod pgBackRest lit les données du bucket</li><li>Pod pgBackRest restaure les données en continu vers le cluster PostgreSQL dans Kubernetes</li></ol><p>Les données doivent être synchronisées en permanence. En fin de compte, je souhaite arrêter PostgreSQL exécuté sur site et conserver uniquement le cluster dans GKE.</p><h2 id=migration>Migration</h2><p>Conditions préalables</p><p>Pour reproduire la configuration, vous aurez besoin des éléments suivants :</p><ul><li>PostgreSQL (v12 ou 13) exécuté quelque part</li><li>pgBackRest installé</li><li>Google Cloud Storage ou n&rsquo;importe quel bucket S3. Mes exemples concerneront GCS.</li><li>cluster Kubernetes</li></ul><p>Configurer la source</p><p>J&rsquo;ai <a href=https://www.percona.com/software/postgresql-distribution>Percona Distribution pour PostgreSQL</a> version 13 qui s&rsquo;exécute sur certaines machines Linux.  </p><p>\1. Configurer <a href=https://github.com/spron-in/blog-data/blob/master/postgres-to-kubernetes/pgbackrest.conf>pgBackrest</a> </p><pre><code># cat /etc/pgbackrest.conf
[global]
log-level-console=info
log-level-file=debug
start-fast=y

[db]
pg1-path=/var/lib/postgresql/13/main
repo1-type=gcs
repo1-gcs-bucket=sp-test-1
repo1-gcs-key=/tmp/gcs.key
repo1-path=/on-prem-pg
</code></pre><ul><li>pg1-path doit pointer vers le répertoire de données PostgreSQL</li><li>repo1-type est défini sur GCS car nous voulons que nos sauvegardes y soient</li><li>La clé se trouve dans le fichier /tmp/gcs.key. La clé peut être obtenue via l&rsquo;interface utilisateur de Google Cloud. En savoir plus à ce sujet <a href=https://cloud.google.com/iam/docs/creating-managing-service-account-keys>ici</a> . </li><li>Les sauvegardes vont être stockées dans le dossier on-prem-pg dans le compartiment sp-test-1</li></ul><p>\2. Modifiez la configuration <code>postgresql.conf</code> pour activer l&rsquo;archivage via pgBackrest   </p><pre><code>archive_mode = on   
archive_command = 'pgbackrest --stanza=db archive-push %p'
</code></pre><p>Un redémarrage est nécessaire après avoir modifié la configuration.</p><p>\3. L&rsquo;opérateur nécessite d&rsquo;avoir un fichier <code>postgresql.conf</code> dans le répertoire de données. Il suffit d&rsquo;avoir un fichier vide :  </p><pre><code>touch /var/lib/postgresql/13/main/postgresql.conf
</code></pre><p>\4. <code>primaryuser</code> doit être créé sur la source pour s&rsquo;assurer que la réplication soit correctement configurée par l&rsquo;opérateur.   </p><pre><code># create user primaryuser with encrypted password '&lt;PRIMARYUSER PASSWORD&gt;' replication;
</code></pre><h2 id=configurer-la-cible>Configurer la cible</h2><p>\1. Déployez Percona Distribution for PostgreSQL Operator sur Kubernetes. En savoir plus à ce sujet <a href=https://www.percona.com/doc/kubernetes-operator-for-postgresql/kubernetes.html>ici</a> . </p><pre><code># create the namespace
kubectl create namespace pgo

# clone the git repository
git clone -b v0.2.0 https://github.com/percona/percona-postgresql-operator/
cd percona-postgresql-operator

# deploy the operator
kubectl apply -f deploy/operator.yaml
</code></pre><p>\2. Modifiez le manifeste de ressource personnalisé principal - deploy/cr.yaml.</p><ul><li>Je ne vais pas changer le nom du cluster et le garder cluster1</li><li>le cluster va fonctionner en mode veille, ce qui signifie qu&rsquo;il va synchroniser les données du bucket GCS. Définissez <code>spec.standby</code> sur <code>true</code> .   </li><li>configurer GCS lui-même. La section <code>spec.backup</code> ressemblerait à ceci ( <code>bucket</code> et <code>repoPath</code> sont les mêmes que dans la configuration pgBackrest ci-dessus)      </li></ul><pre><code> backup:
...
    repoPath: &quot;/on-prem-pg&quot;
...
    storages:
      my-s3:
        type: gcs
        endpointUrl: https://storage.googleapis.com
        region: us-central1-a
        uriStyle: path
        verifyTLS: false
        bucket: sp-test-1
    storageTypes: [
      &quot;gcs&quot;
    ]
</code></pre><ul><li>J&rsquo;aimerais avoir au moins une réplique dans mon cluster PostgreSQL. Définissez <code>spec.pgReplicas.hotStandby.size</code> sur 1.  </li></ul><p>\3. L&rsquo;opérateur doit pouvoir s&rsquo;authentifier auprès de GCS. Pour ce faire, nous devons créer un objet secret appelé <code>&lt;CLUSTERNAME> - dossier - repo - config</code> avec <code>gcs-key</code> dans les données. Ce devrait être la même clé que nous avons utilisée sur la source. Voir l&rsquo;exemple de ce secret <a href=https://github.com/spron-in/blog-data/blob/master/postgres-to-kubernetes/gcs.yaml>ici</a> .     </p><pre><code>kubectl apply -f gcs.yaml
</code></pre><p>\4. Créez des utilisateurs en créant des objets Secrets : <code>postgres</code> et <code>primaryuser</code> (celui que nous avons créé sur la Source). Voir les exemples d&rsquo;utilisateurs Secrets <a href=https://github.com/spron-in/blog-data/blob/master/postgres-to-kubernetes/users.yaml>ici</a> . Les mots de passe doivent être les mêmes que sur la Source.     </p><pre><code>kubectl apply -f users.yaml
</code></pre><p>\5. Déployons maintenant notre cluster sur Kubernetes en appliquant le <code>cr.yaml</code> : </p><pre><code>kubectl apply -f deploy/cr.yaml
</code></pre><h2 id=vérifier-et-dépanner>Vérifier et dépanner</h2><p>Si tout est fait correctement, vous devriez voir ce qui suit dans les journaux du pod principal :</p><pre><code>kubectl -n pgo logs -f --tail=20 cluster1-5dfb96f77d-7m2rs
2021-07-30 10:41:08,286 INFO: Reaped pid=548, exit status=0
2021-07-30 10:41:08,298 INFO: establishing a new patroni connection to the postgres cluster
2021-07-30 10:41:08,359 INFO: initialized a new cluster
Fri Jul 30 10:41:09 UTC 2021 INFO: PGHA_INIT is 'true', waiting to initialize as primary
Fri Jul 30 10:41:09 UTC 2021 INFO: Node cluster1-5dfb96f77d-7m2rs fully initialized for cluster cluster1 and is ready for use
2021-07-30 10:41:18,781 INFO: Lock owner: cluster1-5dfb96f77d-7m2rs; I am cluster1-5dfb96f77d-7m2rs                                 2021-07-30 10:41:18,810 INFO: no action.  i am the standby leader with the lock                                                     2021-07-30 10:41:28,781 INFO: Lock owner: cluster1-5dfb96f77d-7m2rs; I am cluster1-5dfb96f77d-7m2rs                                 2021-07-30 10:41:28,832 INFO: no action.  i am the standby leader with the lock
</code></pre><p>Modifiez certaines données sur la source et assurez-vous qu&rsquo;elles sont correctement synchronisées avec le cluster cible.</p><h2 id=problèmes-courants>Problèmes courants</h2><p>Le message d&rsquo;erreur suivant indique que vous avez oublié de créer le fichier <code>postgresql.conf</code> dans le répertoire de données :  </p><pre><code>FileNotFoundError: [Errno 2] No such file or directory: '/pgdata/cluster1/postgresql.conf' -&gt; '/pgdata/cluster1/postgresql.base.conf'
</code></pre><p>Parfois, il est facile d&rsquo;oublier de créer <code>primaryuser</code> et de voir ce qui suit dans les journaux :  </p><pre><code>psycopg2.OperationalError: FATAL:  password authentication failed for user &quot;primaryuser&quot;
</code></pre><p>Des informations d&rsquo;identification de magasin d&rsquo;objets erronées ou manquantes déclencheront l&rsquo;erreur suivante :</p><pre><code>WARN: repo1: [CryptoError] unable to load info file '/on-prem-pg/backup/db/backup.info' or '/on-prem-pg/backup/db/backup.info.copy':      CryptoError: raised from remote-0 protocol on 'cluster1-backrest-shared-repo': unable to read PEM: [218529960] wrong tag            HINT: is or was the repo encrypted?                                                                                                 CryptoError: raised from remote-0 protocol on 'cluster1-backrest-shared-repo': unable to read PEM: [218595386] nested asn1 error
      HINT: is or was the repo encrypted?
      HINT: backup.info cannot be opened and is required to perform a backup.
      HINT: has a stanza-create been performed?
ERROR: [075]: no backup set found to restore
Fri Jul 30 10:54:00 UTC 2021 ERROR: pgBackRest standby Creation: pgBackRest restore failed when creating standby
</code></pre><h2 id=basculement-ou-cutover>Basculement ou Cutover</h2><p>Tout semble bon et il est temps d&rsquo;effectuer la transition. Dans cet article de blog, je ne couvre que le côté base de données mais n&rsquo;oubliez pas que votre application doit être reconfigurée pour pointer vers le bon cluster PostgreSQL. Il peut être judicieux d&rsquo;arrêter l&rsquo;application avant le basculement.</p><p>\1. Arrêtez le cluster PostgreSQL source pour vous assurer qu&rsquo;aucune donnée n&rsquo;est écrite</p><pre><code>systemctl stop postgresql
</code></pre><p>\2. Faites la promotion du cluster cible en tant que cluster principal. Pour ce faire, supprimez <code>spec.backup.repoPath</code> , remplacez <code>spec.standby</code> par false dans <code>deploy/cr.yaml</code> et appliquez les modifications : 
     </p><pre><code>kubectl apply -f deploy/cr.yaml
</code></pre><p>PostgreSQL sera redémarré automatiquement et vous verrez ce qui suit dans les journaux :</p><pre><code>2021-07-30 11:16:20,020 INFO: updated leader lock during promote
2021-07-30 11:16:20,025 INFO: Changed archive_mode from on to True (restart might be required)
2021-07-30 11:16:20,025 INFO: Changed max_wal_senders from 10 to 6 (restart might be required)
2021-07-30 11:16:20,027 INFO: Reloading PostgreSQL configuration.
server signaled
2021-07-30 11:16:21,037 INFO: Lock owner: cluster1-5dfb96f77d-n4c79; I am cluster1-5dfb96f77d-n4c79
2021-07-30 11:16:21,132 INFO: no action.  i am the leader with the lock
</code></pre><h2 id=conclusion>Conclusion</h2><p>Le déploiement et la gestion de clusters de bases de données n&rsquo;est pas une tâche facile. Percona Distribution for PostgreSQL Operator, récemment publié, automatise les opérations du jour 1 et du jour 2 et transforme l&rsquo;exécution de PostgreSQL sur Kubernetes en un parcours fluide et agréable.</p><p>Kubernetes devenant le plan de contrôle par défaut, la tâche la plus courante pour les développeurs et les équipes d&rsquo;exploitation consiste à effectuer la migration, qui se transforme généralement en un projet complexe. Ce billet de blog montre que la migration de base de données peut être une tâche facile avec un temps d&rsquo;arrêt minimal.</p><p>Nous vous encourageons à essayer notre opérateur. Consultez notre <a href=https://github.com/percona/percona-postgresql-operator/>référentiel github</a> et consultez la <a href=https://www.percona.com/doc/kubernetes-operator-for-postgresql/index.html>documentation</a> .   </p><p>Vous avez trouvé un bug ou vous avez une idée de fonctionnalité ? N&rsquo;hésitez pas à le soumettre dans <a href=https://jira.percona.com/browse/K8SPG>JIRA</a> . </p><p>Pour les questions générales, veuillez soulever le sujet dans le <a href=https://forums.percona.com/c/postgresql/percona-kubernetes-operator-for-postgresql/68>forum de la communauté</a> . </p><p>Vous êtes développeur et vous souhaitez contribuer ? Veuillez lire notre <a href=https://github.com/percona/percona-postgresql-operator/blob/main/CONTRIBUTING.md>CONTRIBUTING.md</a> et envoyer un Pull Request.  </p><p><strong>Percona Distribution for PostgreSQL fournit dans une seule distribution, les meilleurs et les plus critiques des composants entreprise de la communauté open source, conçue et testée pour fonctionner ensemble.</strong></p><p><a href=https://www.percona.com/software/postgresql-distribution><strong>Télécharger Percona Distribution pour PostgreSQL</strong></a></p><p>Source : <a href=https://www.percona.com/blog/migrating-postgresql-to-kubernetes>Blog Percona</a></p><ul class=pa0><li class=list><a href=/tags/postgresql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">PostgreSQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2021</a><div></div></div></footer></body></html>