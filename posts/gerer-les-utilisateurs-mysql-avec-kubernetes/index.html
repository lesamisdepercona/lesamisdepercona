<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Gérer les utilisateurs MySQL avec Kubernetes | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Traduit à partir de l'article de Sergey Pronin intitulé, Manage MySQL Users with Kubernetes"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Gérer les utilisateurs MySQL avec Kubernetes"><meta property="og:description" content="Traduit à partir de l'article de Sergey Pronin intitulé, Manage MySQL Users with Kubernetes"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/gerer-les-utilisateurs-mysql-avec-kubernetes/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail/article13.jpg"><meta property="article:published_time" content="2021-08-26T11:43:01+04:00"><meta property="article:modified_time" content="2021-08-26T11:43:01+04:00"><meta itemprop=name content="Gérer les utilisateurs MySQL avec Kubernetes"><meta itemprop=description content="Traduit à partir de l'article de Sergey Pronin intitulé, Manage MySQL Users with Kubernetes"><meta itemprop=datePublished content="2021-08-26T11:43:01+04:00"><meta itemprop=dateModified content="2021-08-26T11:43:01+04:00"><meta itemprop=wordCount content="1345"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail/article13.jpg"><meta itemprop=keywords content="MySQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail/article13.jpg"><meta name=twitter:title content="Gérer les utilisateurs MySQL avec Kubernetes"><meta name=twitter:description content="Traduit à partir de l'article de Sergey Pronin intitulé, Manage MySQL Users with Kubernetes"><script async src="https://www.googletagmanager.com/gtag/js?id=G-W9SYN1YL24"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-W9SYN1YL24');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-203534013-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-203534013-1');</script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/gerer-les-utilisateurs-mysql-avec-kubernetes/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/gerer-les-utilisateurs-mysql-avec-kubernetes/&text=G%c3%a9rer%20les%20utilisateurs%20MySQL%20avec%20Kubernetes" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/gerer-les-utilisateurs-mysql-avec-kubernetes/&title=G%c3%a9rer%20les%20utilisateurs%20MySQL%20avec%20Kubernetes" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Gérer les utilisateurs MySQL avec Kubernetes</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2021-08-26T11:43:01+04:00>August 26, 2021</time>
<span class="f6 mv4 dib tracked">- 7 minutes read</span>
<span class="f6 mv4 dib tracked">- 1345 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p>Une demande assez courante que nous recevons de la communauté et des clients est de fournir un moyen de gérer les utilisateurs de la base de données avec des opérateurs - à la fois MongoDB et MySQL. Même si nous le voyons comme une tâche intéressante, nos opérateurs sont principalement un outil pour simplifier le déploiement et la gestion de nos logiciels sur Kubernetes. Notre objectif est de fournir un cluster de bases de données prêt à héberger des applications critiques et déployé avec les meilleures pratiques.</p><h2 id=pourquoi-gérer-les-utilisateurs-avec-des-opérateurs>Pourquoi gérer les utilisateurs avec des opérateurs ?</h2><p>Il y a peu de cas d&rsquo;utilisation :</p><ol><li>Simplifiez le pipeline CICD. Il est plus simple d&rsquo;appliquer un seul manifeste que d&rsquo;exécuter plusieurs commandes pour créer l&rsquo;utilisateur une fois la base de données prête.</li><li>Effectuer le contrôle des utilisateurs de la base de données aux développeurs ou aux applications, mais sans fournir un accès direct à la base de données.</li><li>Il existe une opinion selon laquelle Kubernetes passera d&rsquo;un orchestrateur de conteneurs à un plan de contrôle pour tout gérer. C’est une stratégie pour certaines entreprises.</li></ol><p>Nous voulons avoir la fonctionnalité permettant de fournir les utilisateurs des opérateurs. Bien que faisable, il semble que de le faire séparément pour chaque opérateur n’est pas la bonne solution. Il pourrait être unifié.</p><p>Et si nous passions à un autre niveau et nous créions un moyen de provisionner des utilisateurs sur n&rsquo;importe quelle base de données via le plan de contrôle Kubernetes? L&rsquo;utilisateur a créé l&rsquo;instance MySQL sur un cloud public via le plan de contrôle, alors pourquoi ne pas créer l&rsquo;utilisateur DB de la même manière ?</p><p><a href=http://crossplane.io/>Crossplane.io</a> - Un module complémentaire Kubernetes qui permet aux utilisateurs de décrire et de provisionner de manière déclarative l&rsquo;infrastructure via le plan de contrôle k8s. De par sa conception, il est extensible via des « fournisseurs ». L&rsquo;un d&rsquo;eux - <a href=https://github.com/crossplane-contrib/provider-sql/>provider- sql</a> - permet à la fonctionnalité de gérer les utilisateurs MySQL et PostgreSQL (et même les bases de données) via les CRD. Voyons comment le faire fonctionner avec <a href=https://www.percona.com/doc/kubernetes-operator-for-pxc/index.html>Percona XtraDB Cluster Operator</a></p><h2 id=action>Action</h2><p>Pré - requis :</p><ul><li>cluster Kubernetes</li><li>Percona XtraDB Cluster déployé avec Operator (voir la documentation <a href=https://www.percona.com/doc/kubernetes-operator-for-pxc/index.html>ici</a></li></ul><p>L&rsquo;objectif est de créer un objet de ressource personnalisée (CR) via l&rsquo;API Kubernetes pour déclencher crossplane.io afin de créer l&rsquo;utilisateur sur le cluster PXC. En résumé, cela ressemble comme suit :</p><p><img src=/posts/article13/crossplane-provider-sql-1024x489.png alt=image01></p><ol><li>Un utilisateur crée le CR avec utilisateur souhaité et rôle</li><li>Crossplane le detecte</li><li>provider-sql (Crossplane provider) est configuré via un objet secret qui a le point de terminaison PXC et les informations d&rsquo;identification racine</li><li>provider-sql se connecte à PXC et crée l&rsquo;utilisateur</li></ol><p>J&rsquo;ai placé tous les fichiers de cet article de blog dans le référentiel github public avec le runbook condensé qui répertorie simplement toutes les étapes. Vous pouvez tout trouver <a href=https://github.com/spron-in/blog-data/tree/master/crossplane-provider-sql>ici</a> . </p><h2 id=installer-le-crossplane><strong>Installer le crossplane</strong></h2><p>Le moyen le plus simple est de le faire via helm:</p><pre><code>kubectl create namespace crossplane
helm repo add crossplane-alpha https://charts.crossplane.io/alpha
helm install crossplane --namespace crossplane crossplane-alpha/crossplane
</code></pre><p>D&rsquo;autres méthodes d&rsquo;installation peuvent être trouvées dans la <a href=https://crossplane.io/docs/v0.1/install-crossplane.html>documentation crossplane.io</a> . </p><h2 id=installer-le-fournisseur---sql><strong>Installer le fournisseur - sql</strong></h2><p><a href=https://crossplane.io/docs/v0.12/introduction/providers.html>Le Provider dans Crossplane</a> est un concept similaire au <a href=https://www.terraform.io/docs/providers/index.html>Provider de Terraform</a>. Tout dans le crossplane se fait via l' API Kubernetes et cela inclut l&rsquo;installation des fournisseurs.</p><pre><code>$ cat crossplane-provider-sql.yaml
apiVersion: pkg.crossplane.io/v1beta1
kind: Provider
metadata:
  name: provider-sql
spec:
  package: &quot;crossplane/provider-sql:master&quot;

$ kubectl apply -f crossplane-provider-sql.yaml
</code></pre><p>Cela va installer des définitions de ressources personnalisées pour provider-sql qui va être utilisé pour gérer les utilisateurs MySQL sur notre cluster PXC. Documentation complète pour provider-sql peut être trouvée <a href=https://github.com/crossplane-contrib/provider-sql>ici</a> , mais ils ne sont pas très détaillés.</p><h2 id=nous-y-sommes-presque><strong>Nous y sommes presque</strong></h2><p>Tout est installé et nécessite une dernière touche de configuration.</p><ol><li>Créez un secret que provider-sql va utiliser pour se connecter à la base de données MySQL. J&rsquo;ai le cluster1 Percona XtraDB cluster déployé dans un espace de noms pxc et le secret correspondant ressemblera à ceci :</li></ol><pre><code>$ cat crossplane-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: crossplane-secret
  namespace: pxc
stringData:
  username: root
  password: &lt;root password&gt;
  endpoint: cluster1-haproxy.pxc.svc.cluster.local
  port: &quot;3306&quot;

type: Opaque
</code></pre><p>Vous pouvez obtenir le mot de passe root à partir du secret qui est créé lorsque PXC est déployé via l&rsquo;opérateur. Un moyen rapide de l&rsquo;obtenir est comme ceci:</p><pre><code>$ kubectl get secret -n pxc my-cluster-secrets -o yaml | awk '/root:/ {print $2}' | base64 --decode &amp;&amp; echo
&lt;root password&gt;
</code></pre><p>Crossplane utilisera le point de terminaison et le port comme chaîne de connexion MySQL, ainsi que le nom d&rsquo;utilisateur et le mot de passe pour s&rsquo;y connecter. Configurez provider-sql pour obtenir les informations à partir du secret:</p><pre><code>$ cat crossplane-mysql-config.yaml
apiVersion: mysql.sql.crossplane.io/v1alpha1
kind: ProviderConfig
metadata:
  name: cluster1-pxc
spec:
  credentials:
    source: MySQLConnectionSecret
    connectionSecretRef:
      namespace: pxc
      name: crossplane-secret

$ kubectl apply -f crossplane-mysql-config.yaml
</code></pre><p>Vérifions que la configuration est en place :</p><pre><code>$ kubectl get providerconfig.mysql.sql.crossplane.io
NAME           AGE
cluster1-pxc   14s
</code></pre><h2 id=faisons-le><strong>Faisons-le!</strong></h2><p>Tout est prêt. Crossplane peut maintenant se connecter à la base de données et créer les utilisateurs. Du point de vue de Kubernetes et de l&rsquo;utilisateur, il s&rsquo;agit simplement de créer les ressources personnalisées via l&rsquo;API du plan de contrôle.</p><h3 id=création-de-base-de-données><strong>Création de base de données</strong></h3><pre><code>$ cat crossplane-db.yaml
apiVersion: mysql.sql.crossplane.io/v1alpha1
kind: Database
metadata:
  name: my-db
spec:
  providerConfigRef:
    name: cluster1-pxc

$ kubectl apply -f crossplane-db.yaml
database.mysql.sql.crossplane.io/my-db created

$ kubectl get database.mysql.sql.crossplane.io
NAME    READY   SYNCED   AGE
my-db   True    True     14s
</code></pre><p>Cela a créé la base de données sur mon Percona XtraDB cluster:</p><pre><code>$ mysql -u root -p -h cluster1-haproxy
Server version: 8.0.22-13.1 Percona XtraDB Cluster (GPL), Release rel13, Revision a48e6d5, WSREP version 26.4.3
...
mysql&gt; show databases like 'my-db';
+------------------+
| Database (my-db) |
+------------------+
| my-db            |
+------------------+
1 row in set (0.01 sec)
</code></pre><p>La base de données peut également être supprimée via l&rsquo;API Kubernetes - supprimez simplement l&rsquo;objet correspondant <code>database.mysql.sql.crossplane.io.</code> </p><h3 id=création-dutilisateur><strong>Création d&rsquo;utilisateur</strong></h3><p>L&rsquo;utilisateur a besoin d&rsquo;un mot de passe. Le mot de passe ne doit jamais être stocké sous forme de texte brut, alors mettons-le dans un secret :</p><pre><code>$ cat user-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-user-secret
stringData:
  password: mysuperpass
type: Opaque
</code></pre><p>Nous pouvons créer l&rsquo;utilisateur maintenant :</p><pre><code>$ cat crossplane-user.yaml
apiVersion: mysql.sql.crossplane.io/v1alpha1
kind: User
metadata:
  name: my-user
spec:
  providerConfigRef:
    name: cluster1-pxc
  forProvider:
    passwordSecretRef:
      name: my-user-secret
      namespace: default
      key: password
  writeConnectionSecretToRef:
    name: connection-secret
    namespace: default

$ kubectl apply -f crossplane-user.yaml
user.mysql.sql.crossplane.io/my-user created

$ kubectl get user.mysql.sql.crossplane.io
NAME      READY   SYNCED   AGE
my-user   True    True     11s
</code></pre><p>Et ajoutez quelques «grant » :</p><pre><code>$ cat crossplane-grants.yaml
apiVersion: mysql.sql.crossplane.io/v1alpha1
kind: Grant
metadata:
  name: my-grant
spec:
  providerConfigRef:
    name: cluster1-pxc
  forProvider:
    privileges:
      - DROP
      - CREATE ROUTINE
      - EVENT
    userRef:
      name: my-user
    databaseRef:
      name: my-db

$ kubectl apply -f crossplane-grants.yaml
grant.mysql.sql.crossplane.io/my-grant created

$ kubectl get grant.mysql.sql.crossplane.io
NAME       READY   SYNCED   AGE   ROLE      DATABASE   PRIVILEGES
my-grant   True    True     7s    my-user   my-db      [DROP CREATE ROUTINE EVENT]
</code></pre><p>Vérifiez que l&rsquo;utilisateur est là :</p><pre><code>mysql&gt; show grants for 'my-user';
+-----------------------------------------------------------------+
| Grants for my-user@%                                            |
+-----------------------------------------------------------------+
| GRANT USAGE ON *.* TO `my-user`@`%`                             |
| GRANT DROP, CREATE ROUTINE, EVENT ON `my-db`.* TO `my-user`@`%` |
+-----------------------------------------------------------------+
2 rows in set (0.00 sec)
</code></pre><h2 id=garder-létat><strong>Garder l&rsquo;État</strong></h2><p>Kubernetes est déclaratif et ses contrôleurs font toujours de leur mieux pour synchroniser la configuration déclarée et l’état réel. Cela signifie que si vous supprimez l&rsquo;utilisateur manuellement de la base de données (pas via l&rsquo;API Kubernetes), lors du prochain passage d&rsquo;une boucle de réconciliation, Crossplane synchronisera l&rsquo;état et recréera l&rsquo;utilisateur et les « grant » à nouveau.</p><h3 id=conclusion><strong>Conclusion</strong></h3><p>Certaines fonctionnalités d&rsquo;un moteur de base de données diffèrent beaucoup de l&rsquo;autre, mais il existe parfois un modèle. La création d&rsquo;utilisateurs est l&rsquo;un de ces modèles qui peuvent être unifiés sur plusieurs moteurs de base de données. Heureusement, le paysage de la Cloud Native Foundation est immense et se compose de nombreux blocs de construction qui, lorsqu&rsquo;ils sont utilisés ensemble, peuvent fournir de merveilleuses infrastructures ou applications.</p><p>Cet article montre que la communauté a peut-être déjà trouvé une meilleure solution au problème et que la réinventer pourrait être une perte de temps.</p><p>L&rsquo;extension des fournisseurs crossplane.io pour prendre en charge d&rsquo;autres moteurs de base de données (comme MongoDB ) est un défi mais peut être résolu. Nous rédigeons une proposition et travaillerons avec nos équipes et notre communauté pour y parvenir.</p><p>Source : <a href=https://www.percona.com/blog/2021/05/20/manage-mysql-users-with-kubernetes/>Percona Blog</a></p><ul class=pa0><li class=list><a href=/tags/mysql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MySQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2022</a><div></div></div></footer></body></html>