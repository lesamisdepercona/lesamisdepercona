<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Dois-je créer un index sur les clés étrangères dans PostgreSQL? | Les amis de Percona</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Il est generalement vrai que les index améliorent les performances de lecture, mais nous savons également que cela aura toujours un impact sur les écritures. Dans certains cas, cela peut ne donner aucune amélioration des performances. Les clés étrangères (FK) en sont un excellent exemple."><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><meta property="og:title" content="Dois-je créer un index sur les clés étrangères dans PostgreSQL?"><meta property="og:description" content="Il est generalement vrai que les index améliorent les performances de lecture, mais nous savons également que cela aura toujours un impact sur les écritures. Dans certains cas, cela peut ne donner aucune amélioration des performances. Les clés étrangères (FK) en sont un excellent exemple."><meta property="og:type" content="article"><meta property="og:url" content="https://www.lesamisdepercona.fr/posts/index-sur-les-cles-etrangeres-dans-postgresql/"><meta property="og:image" content="https://www.lesamisdepercona.fr/thumbnail2022/article07.jpg"><meta property="article:published_time" content="2022-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-15T00:00:00+00:00"><meta itemprop=name content="Dois-je créer un index sur les clés étrangères dans PostgreSQL?"><meta itemprop=description content="Il est generalement vrai que les index améliorent les performances de lecture, mais nous savons également que cela aura toujours un impact sur les écritures. Dans certains cas, cela peut ne donner aucune amélioration des performances. Les clés étrangères (FK) en sont un excellent exemple."><meta itemprop=datePublished content="2022-02-15T00:00:00+00:00"><meta itemprop=dateModified content="2022-02-15T00:00:00+00:00"><meta itemprop=wordCount content="973"><meta itemprop=image content="https://www.lesamisdepercona.fr/thumbnail2022/article07.jpg"><meta itemprop=keywords content="PostgreSQL,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lesamisdepercona.fr/thumbnail2022/article07.jpg"><meta name=twitter:title content="Dois-je créer un index sur les clés étrangères dans PostgreSQL?"><meta name=twitter:description content="Il est generalement vrai que les index améliorent les performances de lecture, mais nous savons également que cela aura toujours un impact sur les écritures. Dans certains cas, cela peut ne donner aucune amélioration des performances. Les clés étrangères (FK) en sont un excellent exemple."><script async src="https://www.googletagmanager.com/gtag/js?id=G-W9SYN1YL24"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-W9SYN1YL24');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-203534013-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-203534013-1');</script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-blue><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/img/logo.png class="w100 mw5-ns" alt="Les amis de Percona"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Articles page">Articles</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Qui Sommes Nous? page">Qui Sommes Nous?</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tags/ title="Tags page">Tags</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.lesamisdepercona.fr/posts/index-sur-les-cles-etrangeres-dans-postgresql/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.lesamisdepercona.fr/posts/index-sur-les-cles-etrangeres-dans-postgresql/&text=Dois-je%20cr%c3%a9er%20un%20index%20sur%20les%20cl%c3%a9s%20%c3%a9trang%c3%a8res%20dans%20PostgreSQL?" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.lesamisdepercona.fr/posts/index-sur-les-cles-etrangeres-dans-postgresql/&title=Dois-je%20cr%c3%a9er%20un%20index%20sur%20les%20cl%c3%a9s%20%c3%a9trang%c3%a8res%20dans%20PostgreSQL?" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Dois-je créer un index sur les clés étrangères dans PostgreSQL?</h1><p class=tracked>By <strong>Francis</strong></p><time class="f6 mv4 dib tracked" datetime=2022-02-15T00:00:00Z>February 15, 2022</time>
<span class="f6 mv4 dib tracked">- 5 minutes read</span>
<span class="f6 mv4 dib tracked">- 973 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-100-l"><p><img src=/thumbnail2022/article07.jpg alt=thumbnail></p><p><em>Bienvenue sur un blog hebdomadaire où je peux répondre (comme, vraiment répondre) à certaines des questions que j&rsquo;ai vues dans les webinaires que j&rsquo;ai présentés récemment. Si vous avez manqué le dernier, <a href="https://www.brighttalk.com/webcast/18708/513655?utm_source=Percona&utm_medium=brighttalk&utm_campaign=513655">PostgreSQL Performance Tuning Secrets </a>, il peut être utile d&rsquo;en écouter une partie avant ou après avoir lu cet article. Chaque semaine, je vais plonger profondément dans une question. Faites-moi savoir ce que vous pensez dans les commentaires.</em></p><p>Nous entendons constamment dire que les index améliorent les performances de lecture et c&rsquo;est généralement vrai, mais nous savons également que cela aura toujours un impact sur les écritures. Ce dont nous n&rsquo;entendons pas parler trop souvent, c&rsquo;est que dans certains cas, cela peut ne donner aucune amélioration des performances. Cela se produit plus que nous ne le souhaitons et peut se produire plus que nous ne le remarquons, et les clés étrangères (FK) en sont un excellent exemple. Je ne dis pas que tous les index de FK sont mauvais, mais la plupart de ceux que j&rsquo;ai vus sont tout simplement inutiles, ne faisant qu&rsquo;ajouter de la charge au système.</p><p>Par exemple, la relation ci-dessous où nous avons une relation 1 :N entre la table « Supplier» et la table « Product» :</p><p><img src=/posts/2022/article07/img01.png alt=image01></p><p>Si nous prêtons une attention particulière aux FK dans cet exemple, il n&rsquo;y aura pas un nombre élevé de recherches sur la table enfant en utilisant la colonne FK, " <em>SupplierID</em> " dans cet exemple, si nous comparons avec le nombre de recherches en utilisant " <em>ProductID</em> " et probablement " <em>ProductName</em> &ldquo;. L&rsquo;utilisation principale sera de maintenir la cohérence de la relation et de rechercher dans l&rsquo;autre sens, en trouvant le fournisseur d&rsquo;un certain produit. Dans ce cas, l&rsquo;ajout d&rsquo;un index à l&rsquo;enfant FK sans s&rsquo;assurer que le modèle d&rsquo;accès l&rsquo;exige ajoutera le coût supplémentaire de la mise à jour de l&rsquo;index chaque fois que nous mettons à jour la table « <em>Product ».</em></p><h2 id=un-autre-point-auquel-nous-devons-prêter-attention-est-la-cardinalité-de-lindex>Un autre point auquel nous devons prêter attention est la cardinalité de l&rsquo;index</h2><p>Si la cardinalité de l&rsquo;index est trop faible, Postgres ne l&rsquo;utilisera pas et l&rsquo;index sera simplement ignoré. On peut se demander pourquoi cela se produit et si cela ne serait pas encore moins cher pour la base de données de parcourir, par exemple, la moitié des index au lieu de faire une analyse complète de la table? La réponse est non, en particulier pour les bases de données qui utilisent des tables de tas comme Postgres. L&rsquo;accès à la table dans Postgres est principalement séquentiel, ce qui est plus rapide que l&rsquo;accès aléatoire dans les disques durs en rotation et encore un peu plus rapide sur les disques SSD, tandis que l&rsquo;accès à l&rsquo;index b+-tree est aléatoire par nature.</p><p>Lorsque Postgres utilise un index, il doit ouvrir le fichier d&rsquo;index, trouver les enregistrements dont il a besoin, puis ouvrir le fichier de table, effectuer une recherche à l&rsquo;aide des adresses de page obtenues à partir des index, en modifiant le modèle d&rsquo;accès de séquentiel à aléatoire et en fonction des données distribution, il accédera probablement à la majorité des pages de la table, se terminant par une analyse complète de la table mais utilisant maintenant un accès aléatoire, ce qui est beaucoup plus coûteux. Si nous avons des colonnes avec une faible cardinalité et que nous avons vraiment besoin de les indexer, nous devons utiliser une alternative aux index b-tree, par exemple, un index GIN, mais c&rsquo;est un sujet pour une autre discussion.</p><h2 id=avec-tout-cela-on-peut-penser-que-les-index-fk-sont-toujours-mauvais-et-ne-jamais-les-utiliser-sur-une-table-enfant-nest-ce-pas>Avec tout cela, on peut penser que les index FK sont toujours mauvais et ne jamais les utiliser sur une table enfant, n&rsquo;est-ce pas?</h2><p>Eh bien, ce n&rsquo;est pas vrai non plus et il y a de nombreuses circonstances où ils sont utiles et nécessaires, par exemple, l&rsquo;image ci-dessous a deux autres tableaux, " Customer&rdquo; et " Order" :</p><p><img src=/posts/2022/article07/img02.png alt=image02></p><p>Il peut être pratique d&rsquo;avoir un index sur la table enfant " <em>Order-> CustomerId</em> " car il est courant d&rsquo;afficher toutes les commandes d&rsquo;un certain utilisateur et la colonne &ldquo;<em>CustomerId</em> " de la table &ldquo;Order&rdquo; sera utilisée assez fréquemment comme clé de recherche .</p><p>Un autre bon exemple est de fournir une méthode plus rapide pour valider l&rsquo;intégrité référentielle. Si l&rsquo;on a besoin de changer la table parent (mettre à jour ou supprimer une clé parent), les enfants doivent être vérifiés pour s&rsquo;assurer que la relation n&rsquo;est pas rompue. Dans ce cas, avoir un index du côté de l&rsquo;enfant aiderait à améliorer les performances. Dans ce cas, l’index est utile mais &ldquo;dépendant de la charge&rdquo;. Si la clé parent a de nombreuses suppressions, cela peut être envisageable, cependant, s&rsquo;il s&rsquo;agit d&rsquo;une table principalement statique ou ayant principalement des insertions ou des mises à jour dans les autres colonnes autres que la colonne de clé parent, ce n&rsquo;est pas un bon candidat pour avoir un index sur les tables enfants.</p><p>Il existe de nombreux autres exemples qui peuvent être donnés pour expliquer pourquoi un index sur la table enfant peut être utile et vaut le coût/la pénalité d&rsquo;écriture supplémentaire.</p><h2 id=conclusion>Conclusion</h2><p><strong>Le point à retenir ici est que nous ne devons pas créer d&rsquo;index sans distinction sur tous les FK, car beaucoup d&rsquo;entre eux ne seront tout simplement pas utilisés ou si rarement utilisés qu&rsquo;ils n&rsquo;en valent pas la peine.</strong> Il est préférable de concevoir initialement la base de données avec les FK mais pas les index et de les ajouter pendant que la base de données se développe et que nous comprenons la charge de travail. Il est possible qu&rsquo;à un moment donné, nous trouvions que nous ayons besoin d&rsquo;un index sur « <em>Product-> SupplierId</em> » en raison de notre charge de travail et que l&rsquo;index sur « <em>Order-> CustomerId</em> » ne soit plus nécessaire. Les charges changent et la distribution des données également, l&rsquo;index doit les suivre et ne pas être traité comme des entités immuables.</p><p>Source : <a href=https://www.percona.com/blog/should-i-create-an-index-on-foreign-keys-in-postgresql/>Percona</a></p><ul class=pa0><li class=list><a href=/tags/postgresql class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">PostgreSQL</a></li></ul><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-dark-blue bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.lesamisdepercona.fr/>&copy; Les amis de Percona 2022</a><div></div></div></footer></body></html>